<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta content="#101010" name="theme-color"/>
<link href="/favicon.svg" rel="icon" sizes="any" type="image/svg+xml">
<link href="/favicon.ico" rel="alternate icon">
<link href="/static/css/main.css" rel="stylesheet">
<meta http-equiv="onion-location" content="http://64wv2uqwjacqer7z5d6ooqgrvjwlioizmo7hgmxm7zxerbvgnoqhafid.onion/posts/resident-ssh-keys-on-windows.html">
<title>YubiKey resident SSH keys on Windows+WSL</title>
<meta property="og:title" content="YubiKey resident SSH keys on Windows+WSL">
<meta property="og:description" content="Getting YubiKeys, Windows and WSL to all just get along.">
</head>
<body>
<header>
<nav>
<a href="/">zakaria.org</a><a href="/posts/">posts</a><a href="/projects.html">code</a><a style="float:right" href="/about.html">about</a></nav>
</header>
<main>
<h1 id="YubiKey%20resident%20SSH%20keys%20on%20Windows+WSL">YubiKey resident SSH keys on Windows+WSL</h1>

<p>This is a guide that documents how to use YubiKey resident SSH keys on Windows, with passthrough to WSL2 via <code>npiperelay</code> and <code>socat</code>.</p>

<p>It&#8217;s important to understand that with this setup, WSL is using the ssh-agent service running on Windows, not WSL. However, because of the magic of Unix pipes+sockets, you shouldn&#8217;t notice any functional differences.</p>

<h2 id="Download%20OpenSSH">Download OpenSSH</h2>

<p>As of writing, OpenSSH 8.1p1 (the default on Windows 10), does not support importing resident SSH keys from YubiKeys via <code>ssh-add</code> or <code>ssh-keygen</code>. So first we need to update OpenSSH for Windows:</p>

<ol>
<li>Download the latest .zip from the <a href="https://github.com/PowerShell/Win32-OpenSSH/releases">Win32-OpenSSH GitHub releases page</a>. (OpenSSH-Win64.zip in my case).</li>
<li>Unzip it, and run the <code>install-sshd.ps1</code> script as Administrator.</li>
</ol>

<p>This script will update the appropriate Windows system services (<code>sshd</code> and <code>ssh-agent</code>) to use the executables in the current directory instead of the default ones. The script will not, however install the the executables into your PATH (of which <code>ssh-add</code> and <code>ssh-keygen</code> we&#8217;ll need later on) so remember where you&#8217;ve unzipped it.</p>

<p>Next restart the <code>ssh-agent</code> Windows service:</p>

<ol>
<li>Open <code>services.msc</code> from Run (<code>Win+R</code>).</li>
<li>Find &#8220;OpenSSH Authentication Agent&#8221;, right click and select &#8220;Restart&#8221;.</li>
</ol>

<h2 id="Configuring%20WSL2">Configuring WSL2</h2>

<ol>
<li><p>Install <code>socat</code> using your package manager (e.g. <code>sudo apt install socat</code>).</p></li>
<li><p>Download the latest npiperelay from the <a href="https://github.com/jstarks/npiperelay/releases">GitHub releases page</a>. Unzip it, and copy npiperelay.exe to somewhere in your WSL&#8217;s <code>$PATH</code> (<code>~&#47;bin&#47;npiperelay.exe</code> in my case).</p></li>
<li><p>In your <code>~&#47;.profile</code>, or <code>~&#47;.bashrc</code> shell startup script add the following (adapted from the <a href="https://github.com/rupor-github/wsl-ssh-agent"><code>wsl-ssh-agent</code> README</a>):</p>

<pre><code>export NPIPE_CMD=$(command -v npiperelay.exe)
export SSH_AUTH_SOCK=$HOME&#47;.ssh&#47;agent.sock

# setup socat
ss -a | grep -q $SSH_AUTH_SOCK
if [ "$?" -ne "0" ]; then
    rm -f $SSH_AUTH_SOCK
    ( setsid socat UNIX-LISTEN:$SSH_AUTH_SOCK,fork EXEC:"$NPIPE_CMD -ei -s &#47;&#47;.&#47;pipe&#47;openssh-ssh-agent",nofork &#38; ) &#62;&#47;dev&#47;null 2&#62;&#38;1
fi

# add your ssh private key paths here ...
ssh-add ~&#47;.ssh&#47;id_ed25519 ~&#47;.ssh&#47;id_rsa
</code></pre></li>
</ol>

<h2 id="Importing%20resident%20SSH%20keys">Importing resident SSH keys</h2>

<p>Importing resident ssh private keys from the YubiKey via <code>ssh-keygen -K</code> isn&#8217;t supported on the default version of OpenSSH installed on Windows 10. However, we can make use of the updated binaries we downloaded previously, which do support importing resident ssh keys:</p>

<ol>
<li>Open a privileged <strong>Administrator</strong> PowerShell window. It must be a privileged PowerShell window, otherwise it will fail with an &#8220;invalid format&#8221; error.</li>
<li><code>cd</code> to the directory the previously downloaded OpenSSH binaries reside (the path I told you to keep a not of).</li>
<li>Run <code>.\ssh-keygen -K</code>, and follow the prompts:</li>
</ol>

<p><img src="/static/img/import-resident-key.png" alt="screencap of PowerShell window showing the steps to import a resident ssh key" /></p>

<p>There is another method that requires a second device running anything that isn&#8217;t Windows (Linux, *BSD, etc). I did this way before realising I could use the updated <code>ssh-keygen</code> binary:</p>

<ol>
<li>Import the resident keys to a file; <code>ssh-keygen -K -f .&#47;id_ed25519_sk</code>, (make sure to set a password).</li>
<li>Either copy the resulting file to a USB drive, or upload it somewhere private (this is, after all, your <em>private</em> key).</li>
<li>Copy&#47;download the file onto your Windows machine, and add it to the authentication agent via <code>ssh-add c:\path\to\file</code>.</li>
</ol>

<h2 id="Adding%20keys%20to%20the%20agent">Adding keys to the agent</h2>

<p>Adding keys to the agent is fairly simple, whether in WSL or Windows. Just use the <code>ssh-add</code> command. </p>

<p>In WSL2:</p>

<pre><code>$ ssh-add &#47;path&#47;to&#47;file
</code></pre>

<p>In Windows (PowerShell):</p>

<pre><code>PS C:\Windows\system32&#62; ssh-add C:\path\to\file
</code></pre>

<h3 id="Automating">Automating</h3>

<p>If like me you have named your SSH keys in a non-standard way, or for some other reason ssh-agent won&#8217;t load your keys on startup, we can write a simple PowerShell one-liner that runs at login:</p>

<pre><code>C:\Users\zzz\Documents\bin\OpenSSH-Win64\ssh-add.exe "$env:USERPROFILE\.ssh\id_yubikey" "$env:USERPROFILE\.ssh\id_something_nonstandard"
</code></pre>

<p>You will need to replace <code>C:\Users\zzz\Documents\bin\OpenSSH-Win64\</code> with the path to where you unzipped Win32-OpenSSH previously (hope you didn&#8217;t forget!).</p>

<p>Save this script as <code>ssh-keys.ps1</code> in: <code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</code>, and it should run at startup, prompting you for a password in a PowerShell window if your keys are password protected.</p>

<p>Similarly, for adding the private keys in WSL2 you can add a <code>ssh-add &#47;path&#47;to&#47;key1 &#47;path&#47;to&#47;key1</code> line to your shell rc.</p>
</main>
<footer>
<br><hr>
<p>posted: [&nbsp;2022-03-23&nbsp;]</p>
<p>view: [&nbsp;<a href="/posts/resident-ssh-keys-on-windows.md">plaintext</a>&nbsp;|&nbsp;<a href="http://64wv2uqwjacqer7z5d6ooqgrvjwlioizmo7hgmxm7zxerbvgnoqhafid.onion/posts/resident-ssh-keys-on-windows.html">hidden service</a>&nbsp;]</p>
<div class="qrbox">
<details class="qr"><summary>show qr: [ clear net ]</summary> <svg width="4.34cm" height="4.34cm" viewBox="0 0 41 41" preserveAspectRatio="none" version="1.1" xmlns="http://www.w3.org/2000/svg">
	<g id="QRcode">
		<rect x="0" y="0" width="41" height="41" fill="#ffffff"/>
		<path style="stroke:#000000" transform="translate(4,4.5)" d="M0,0h7M10,0h1M12,0h2M15,0h1M17,0h3M21,0h1M23,0h1M26,0h7M0,1h1M6,1h1M8,1h1M10,1h1M13,1h3M20,1h3M24,1h1M26,1h1M32,1h1M0,2h1M2,2h3M6,2h1M12,2h2M15,2h2M19,2h1M21,2h4M26,2h1M28,2h3M32,2h1M0,3h1M2,3h3M6,3h1M8,3h3M12,3h1M14,3h1M17,3h1M20,3h1M22,3h1M26,3h1M28,3h3M32,3h1M0,4h1M2,4h3M6,4h1M9,4h1M16,4h8M26,4h1M28,4h3M32,4h1M0,5h1M6,5h1M8,5h2M11,5h2M15,5h3M20,5h1M26,5h1M32,5h1M0,6h7M8,6h1M10,6h1M12,6h1M14,6h1M16,6h1M18,6h1M20,6h1M22,6h1M24,6h1M26,6h7M9,7h3M14,7h3M21,7h3M0,8h5M6,8h4M11,8h1M17,8h1M19,8h2M22,8h4M27,8h1M29,8h1M31,8h1M4,9h1M10,9h1M12,9h3M16,9h5M23,9h2M26,9h2M30,9h3M1,10h2M5,10h2M8,10h1M10,10h1M13,10h3M17,10h1M20,10h2M25,10h2M29,10h1M31,10h1M2,11h4M7,11h1M12,11h2M15,11h2M18,11h1M20,11h5M26,11h2M30,11h1M0,12h1M2,12h1M4,12h1M6,12h5M12,12h1M14,12h5M22,12h1M25,12h1M27,12h3M0,13h1M3,13h1M7,13h1M9,13h1M16,13h6M23,13h1M26,13h1M31,13h2M0,14h1M3,14h4M10,14h3M15,14h1M20,14h3M24,14h3M31,14h1M0,15h2M5,15h1M9,15h1M11,15h1M14,15h2M19,15h1M21,15h1M25,15h4M30,15h1M1,16h1M4,16h3M8,16h1M11,16h1M17,16h1M19,16h1M22,16h1M25,16h1M27,16h2M31,16h1M2,17h2M7,17h1M12,17h3M16,17h1M19,17h3M23,17h1M25,17h2M29,17h1M31,17h2M1,18h1M3,18h1M5,18h2M8,18h2M13,18h3M17,18h1M20,18h3M27,18h3M31,18h1M0,19h1M4,19h1M7,19h3M12,19h2M16,19h1M20,19h5M26,19h2M30,19h1M2,20h6M12,20h1M14,20h1M17,20h1M19,20h1M22,20h1M25,20h1M28,20h1M31,20h1M0,21h1M3,21h2M9,21h1M17,21h3M23,21h1M26,21h1M29,21h1M31,21h2M0,22h1M2,22h2M5,22h2M8,22h1M11,22h2M15,22h2M18,22h1M22,22h1M25,22h1M29,22h1M31,22h1M0,23h1M4,23h1M8,23h1M10,23h2M14,23h1M21,23h1M23,23h1M25,23h3M29,23h2M0,24h1M3,24h1M6,24h2M9,24h3M15,24h3M19,24h1M22,24h8M32,24h1M8,25h2M12,25h3M16,25h7M24,25h1M28,25h1M32,25h1M0,26h7M8,26h1M13,26h5M20,26h5M26,26h1M28,26h1M31,26h1M0,27h1M6,27h1M9,27h1M12,27h2M16,27h1M18,27h2M21,27h1M23,27h2M28,27h5M0,28h1M2,28h3M6,28h1M8,28h3M12,28h1M14,28h4M20,28h1M24,28h5M32,28h1M0,29h1M2,29h3M6,29h1M8,29h1M10,29h1M16,29h1M18,29h3M24,29h1M27,29h2M30,29h3M0,30h1M2,30h3M6,30h1M8,30h1M10,30h3M15,30h2M20,30h3M24,30h1M26,30h1M29,30h2M0,31h1M6,31h1M8,31h1M11,31h1M14,31h1M16,31h1M18,31h2M21,31h3M25,31h2M28,31h3M0,32h7M8,32h2M11,32h1M17,32h1M20,32h1M22,32h7M31,32h1"/>
	</g>
</svg> </details>
<details class="qr"><summary>show qr: [ onion url ]</summary> <!-- Created with qrencode 4.1.1 (https://fukuchi.org/works/qrencode/index.html) -->
<svg width="5.19cm" height="5.19cm" viewBox="0 0 49 49" preserveAspectRatio="none" version="1.1" xmlns="http://www.w3.org/2000/svg">
	<g id="QRcode">
		<rect x="0" y="0" width="49" height="49" fill="#ffffff"/>
		<path style="stroke:#000000" transform="translate(4,4.5)" d="M0,0h7M9,0h3M13,0h1M16,0h2M19,0h2M22,0h2M25,0h2M28,0h1M31,0h2M34,0h7M0,1h1M6,1h1M8,1h3M12,1h6M20,1h2M25,1h6M32,1h1M34,1h1M40,1h1M0,2h1M2,2h3M6,2h1M9,2h5M15,2h1M17,2h5M24,2h1M28,2h1M31,2h1M34,2h1M36,2h3M40,2h1M0,3h1M2,3h3M6,3h1M8,3h1M11,3h2M14,3h3M20,3h1M22,3h4M29,3h1M32,3h1M34,3h1M36,3h3M40,3h1M0,4h1M2,4h3M6,4h1M9,4h1M11,4h1M13,4h1M15,4h1M17,4h2M22,4h2M28,4h1M31,4h2M34,4h1M36,4h3M40,4h1M0,5h1M6,5h1M8,5h2M11,5h1M15,5h4M20,5h1M24,5h1M27,5h2M30,5h1M32,5h1M34,5h1M40,5h1M0,6h7M8,6h1M10,6h1M12,6h1M14,6h1M16,6h1M18,6h1M20,6h1M22,6h1M24,6h1M26,6h1M28,6h1M30,6h1M32,6h1M34,6h7M9,7h1M11,7h1M15,7h1M18,7h1M21,7h1M23,7h1M26,7h1M28,7h1M32,7h1M0,8h5M6,8h3M10,8h1M12,8h6M20,8h1M22,8h5M29,8h1M31,8h1M33,8h1M35,8h1M37,8h1M39,8h1M0,9h1M5,9h1M7,9h1M9,9h1M11,9h1M16,9h1M19,9h1M21,9h1M23,9h1M25,9h1M28,9h1M30,9h3M34,9h4M40,9h1M2,10h1M5,10h5M15,10h2M18,10h1M20,10h3M26,10h5M32,10h1M35,10h1M2,11h1M5,11h1M8,11h5M14,11h1M16,11h1M20,11h2M23,11h1M26,11h1M28,11h1M35,11h3M40,11h1M2,12h1M4,12h1M6,12h1M8,12h5M18,12h2M22,12h5M29,12h1M37,12h2M40,12h1M0,13h5M7,13h1M14,13h4M20,13h1M23,13h2M26,13h1M28,13h1M30,13h2M34,13h3M40,13h1M0,14h1M4,14h1M6,14h1M10,14h3M18,14h2M21,14h2M25,14h4M0,15h1M2,15h1M8,15h4M14,15h1M16,15h1M18,15h7M26,15h3M32,15h3M36,15h2M39,15h1M0,16h2M4,16h1M6,16h1M9,16h6M17,16h1M19,16h1M22,16h1M24,16h3M29,16h1M33,16h1M35,16h1M38,16h1M5,17h1M9,17h1M11,17h1M13,17h1M16,17h5M23,17h1M26,17h1M28,17h2M31,17h2M34,17h3M39,17h2M2,18h2M6,18h1M8,18h2M12,18h4M17,18h1M21,18h2M25,18h3M30,18h1M33,18h1M36,18h1M39,18h1M1,19h1M3,19h3M9,19h1M11,19h1M13,19h1M16,19h3M21,19h2M24,19h1M26,19h1M28,19h1M30,19h2M34,19h3M39,19h2M2,20h3M6,20h2M9,20h3M14,20h1M16,20h1M19,20h2M22,20h2M25,20h3M29,20h4M35,20h1M37,20h2M40,20h1M0,21h1M7,21h3M12,21h1M15,21h1M18,21h1M23,21h1M30,21h9M40,21h1M0,22h3M4,22h3M8,22h1M13,22h4M20,22h1M22,22h1M25,22h1M27,22h4M33,22h1M35,22h1M37,22h2M2,23h2M7,23h1M12,23h1M15,23h1M21,23h3M30,23h6M37,23h1M39,23h1M0,24h2M3,24h1M5,24h3M9,24h1M12,24h4M17,24h1M20,24h1M24,24h8M35,24h1M37,24h4M1,25h1M3,25h1M8,25h1M10,25h2M16,25h1M19,25h2M22,25h2M25,25h2M29,25h1M31,25h2M34,25h1M36,25h1M38,25h3M1,26h1M4,26h3M10,26h1M15,26h2M18,26h1M20,26h3M24,26h1M27,26h1M32,26h3M38,26h1M2,27h1M7,27h1M9,27h3M14,27h1M16,27h1M20,27h2M26,27h3M31,27h2M35,27h2M40,27h1M0,28h2M3,28h4M11,28h2M15,28h1M18,28h2M21,28h1M23,28h1M25,28h5M38,28h1M40,28h1M0,29h1M3,29h1M10,29h1M13,29h4M20,29h2M23,29h1M28,29h1M30,29h5M36,29h1M39,29h2M0,30h1M2,30h1M4,30h1M6,30h1M8,30h2M11,30h2M17,30h3M22,30h1M25,30h5M32,30h1M35,30h1M37,30h2M0,31h1M3,31h1M5,31h1M7,31h3M11,31h1M14,31h1M16,31h1M18,31h6M27,31h1M32,31h1M36,31h2M0,32h1M2,32h2M6,32h2M9,32h1M11,32h4M17,32h1M19,32h1M22,32h5M29,32h1M32,32h7M40,32h1M8,33h1M10,33h2M13,33h1M16,33h5M23,33h1M25,33h1M28,33h2M31,33h2M36,33h5M0,34h7M8,34h1M10,34h1M12,34h4M17,34h1M20,34h1M22,34h1M25,34h8M34,34h1M36,34h3M0,35h1M6,35h1M9,35h1M11,35h1M13,35h1M16,35h5M23,35h1M27,35h2M31,35h2M36,35h1M0,36h1M2,36h3M6,36h1M8,36h1M10,36h2M14,36h3M20,36h3M24,36h6M32,36h5M38,36h3M0,37h1M2,37h3M6,37h1M8,37h3M12,37h1M15,37h1M18,37h1M23,37h1M25,37h1M28,37h4M35,37h1M37,37h1M39,37h2M0,38h1M2,38h3M6,38h1M8,38h3M14,38h5M20,38h2M24,38h2M27,38h4M34,38h1M36,38h1M0,39h1M6,39h1M8,39h1M12,39h1M15,39h1M18,39h1M21,39h1M27,39h2M30,39h1M32,39h1M35,39h1M37,39h1M39,39h1M0,40h7M8,40h1M12,40h2M15,40h3M22,40h1M25,40h7M33,40h1M35,40h1M37,40h2"/>
	</g>
</svg> </details>
</div>
(C) <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>
</footer>
</body>
</html>
