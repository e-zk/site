<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta content="#101010" name="theme-color"/>
<link href="/favicon.svg" rel="icon" sizes="any" type="image/svg+xml">
<link href="/favicon.ico" rel="alternate icon">
<link href="/static/css/main.css" rel="stylesheet">
<meta http-equiv="onion-location" content="http://64wv2uqwjacqer7z5d6ooqgrvjwlioizmo7hgmxm7zxerbvgnoqhafid.onion/posts/stagit-setup.html">
<title>My stagit setup</title>
<meta property="og:title" content="My stagit setup">
<meta property="og:description" content="Setting up a static git web interface on OpenBSD with stagit + httpd(8).">
</head>
<body>
<header>
<nav>
<a href="/">zakaria.org</a><a href="/posts/">posts</a><a href="/projects.html">code</a><a style="float:right" href="/about.html">about</a></nav>
</header>
<main>
<h1 id="stagit%20setup%20on%20OpenBSD">stagit setup on OpenBSD</h1>

<p><a href="https://codemadness.org/stagit.html">stagit</a> is a static page generator for git repos. It&#8217;s very minimal - which I like.</p>

<p>In this post I&#8217;ll detail how I set up <a href="https://git.zakaria.org/">git.zakaria.org</a> on my OpenBSD server.</p>

<p>The majority of my setup is based upon a post by <code>poptart</code>. Be sure to check out the original post here: <a href="https://hosakacorp.net/p/stagit-server.html">https:&#47;&#47;hosakacorp.net&#47;p&#47;stagit-server.html</a>. It&#8217;s pretty well done, and easy to follow (unlike my post here - which is really more for my sake when I inevitably bork my server again and have to re-do it all). <code>poptart</code> has some other great OpenBSD-related posts on there as well.</p>

<h2 id="Setup">Setup</h2>

<p>On the server install <code>git</code>, create the <code>_git</code> user, and make some directories:</p>

<pre><code>server# pkg_add git libgit2
server# groupadd _git
server# mkdir -p -m 744 &#47;var&#47;git&#47;repos &#47;var&#47;git&#47;template
server# useradd -g _git -L daemon -c "git backend user" -d &#47;var&#47;git&#47;repos -s &#47;usr&#47;local&#47;bin&#47;git-shell _git
server# chown _git:_git &#47;var&#47;git&#47;repos
</code></pre>

<p>The directories we created:</p>

<ul>
<li><code>&#47;var&#47;www&#47;repos</code> contains the bare git files (also the <code>$HOME</code> of user <code>_git</code>)</li>
<li><code>&#47;var&#47;git&#47;template</code> will contain the template for new repositories.</li>
</ul>

<p>The next steps are only if like me you&#8217;ve made source changes to stagit and you&#8217;d like to use your custom version. If you want to use plain stagit, install it on the server with <code>pkg_add stagit</code>.<br/>
On another machine, compile stagit and <code>sftp</code> it over to the server:</p>

<pre><code>laptop$ make
laptop$ md5 stagit stagit-index
laptop$ # remember these checksums for verifying it&#39;s been copied over correctly
laptop$ sftp enderman &#60;&#60;EOF
&#62; put stagit
&#62; put stagit-index
&#62; bye
EOF
</code></pre>

<p>Back on the server, verify the binaries were copied over correctly:</p>

<pre><code>server# md5 stagit stagit-index
server# # verify the checksums
</code></pre>

<p>Copy these binaries to <code>&#47;usr&#47;local&#47;bin</code> and set permissions appropriately:</p>

<pre><code>server# cp stagit{,-index} &#47;usr&#47;local&#47;bin
server# chown root:bin &#47;usr&#47;local&#47;bin&#47;stagit{,-index} 
server# chmod 755 &#47;usr&#47;local&#47;bin&#47;stagit{,-index}
</code></pre>

<p>The following is a message from the future:</p>

<blockquote>
<p>I wrote this post a while ago. But I recall abandoning the modified stagit binary setup
purely because the libraries on my laptop were newer than my server, and I 
could not get static compilation to work&#8230; 
So I gave up and installed stagit via <code>pkg_add stagit</code> on the server :P</p>
</blockquote>

<h2 id="Scripts">Scripts</h2>

<p>Next we&#8217;ll configure a few scripts:</p>

<ul>
<li><code>&#47;var&#47;git&#47;repos&#47;template&#47;post-receive</code><br/>
Will be executed every time we push to a repo.</li>
<li><code>&#47;usr&#47;local&#47;bin&#47;stagit-gen-index</code><br/>
A helper script to generate the index page.</li>
<li><code>&#47;usr&#47;local&#47;bin&#47;stagit-newrepo</code><br/>
Script to run to create a new repository.</li>
<li><code>&#47;usr&#47;local&#47;bin&#47;stagit-chdesc</code><br/>
Script to change the description of an existing repository.</li>
</ul>

<p>Some internal variables will be shared between these scripts, for instance the
git user, htdocs path, etc. Instead of writing these out into each script we
can create a config file that each script will source before running anything.<br/>
In <code>&#47;var&#47;git&#47;config.rc</code>:</p>

<pre><code># shared variables
GIT_HOME="&#47;var&#47;git"
GIT_REPOS="${GIT_HOME}&#47;repos"
WWW_HOME="&#47;var&#47;www&#47;htdocs&#47;git.zakaria.org
CLONE_URI="_git@git.zakaria.org"
DEFAULT_OWNER="zakaria"
DEFAULT_DESC=""
GIT_USER="_git"
</code></pre>

<p>We restrict access to this file to <code>root:wheel</code>:</p>

<pre><code>server# chown root:wheel &#47;var&#47;git&#47;config.rc
</code></pre>

<p>After a <code>git push</code> we want the server to (re)generate the static html pages. To do this, we write a script in <code>&#47;var&#47;git&#47;template&#47;post-receive</code>:</p>

<pre><code>#!&#47;bin&#47;sh
# Author: Cale "poptart" Black
# Modified by: zakaria @ zakaria.org
# License: MIT

set -euf

. &#47;var&#47;git&#47;config.rc

export LC_TYPE="en_US.UTF-8"
src="$(pwd)"
name="$(basename "$src")"
dest="${WWW_HOME}&#47;$(basename "$name" &#39;.git&#39;)"
mkdir -p "$dest"
cd "$dest" || exit 1

echo "[stagit] building $dest"
&#47;usr&#47;local&#47;bin&#47;stagit "$src"

echo "[stagit] linking $dest"
# if a README.html exists use that as the index.html
# if not use log.html
if [ -f "README.html" ]; then
    ln -sf README.html index.html
else
    ln -sf log.html index.html
fi
ln -sf ..&#47;style.css style.css
ln -sf ..&#47;logo.png logo.png
</code></pre>

<p>Next, we need a script to generate the stagit <code>&#47;index.html</code>. In <code>&#47;usr&#47;local&#47;bin&#47;stagit-gen-index</code>:</p>

<pre><code>#!&#47;bin&#47;sh 
# Author: Cale "poptart" Black
# License: MIT

set -eu

. &#47;var&#47;git&#47;config.rc
stagit-index "${GIT_REPOS}&#47;*.git" &#62; "${WWW_HOME}&#47;index.html"
</code></pre>

<p>The next script will be used to setup a new repository. In <code>&#47;usr&#47;local&#47;bin&#47;stagit-newrepo</code>:</p>

<pre><code>#!&#47;bin&#47;sh
# Author: Cale "poptart" Black
# Modified by: zakaria @ zakaria.org
# License: MIT
# Usage: stagit-newrepo &#60;name&#62; [desc] [author]

set -eu

. &#47;var&#47;git&#47;config.rc

log() {
    printf &#39;%s\n&#39; "$*" &#62;&#38;2
}
die() {
    log "error: $*"
    printf &#39;exiting...\n&#39;
    exit 1
}

REPO="$1"
DESC="${2:-$DEFAULT_DESC}"
OWNER="${3:-$DEFAULT_OWNER}"

if [ -z "$REPO" ]; then
    die "no repo name given"
fi

REPO_PATH="${GIT_REPOS}&#47;${REPO}.git"

git init --bare "$REPO_PATH"
cp "${GIT_HOME}&#47;template&#47;post-receive" "${REPO_PATH}&#47;hooks&#47;post-receive"
echo "${CLONE_URI}&#47;${REPO}.git" &#62; "${REPO_PATH}&#47;url"
echo "$OWNER" &#62; "${REPO_PATH}&#47;owner"
echo "$DESC" &#62; "${REPO_PATH}&#47;description"

chmod u+x "${REPO_PATH}&#47;hooks&#47;post-receive"
mkdir "${WWW_HOME}&#47;${REPO}"
&#47;usr&#47;local&#47;bin&#47;stagit-gen-index
</code></pre>

<p>At the end of this script we call our <code>stagit-gen-index</code> helper script to regenerate
the <code>index.html</code>.</p>

<p>The last script is a simple wrapper that will allow us to change a repo&#8217;s description:</p>

<pre><code>#!&#47;bin&#47;sh
# Author: zakaria &#47; zakaria.org
# License: MIT
# Usage: stagit-chdesc &#60;repo&#62; &#60;new_description&#62;

set -eu

. &#47;var&#47;git&#47;config.rc

log() {
    printf &#39;%s\n&#39; "$*" &#62;&#38;2
}
die() {
    log "error: $*"
    printf &#39;exiting...\n&#39;
    exit 1
}

REPO="$1"
DESC="$2"

if [ -z "$REPO" ]; then
    die "no repo name provided"
fi
if [ -z "$DESC" ]; then
    die "no new description provided"
fi

REPO_PATH="${GIT_REPOS}&#47;${REPO}.git"

echo "$DESC" &#62; ${REPO_PATH}&#47;description
</code></pre>

<p>Then set the appropriate permissions and restrictions for these scripts:</p>

<pre><code>$ chmod +x &#47;usr&#47;local&#47;bin&#47;stagit-{gen-index,newrepo,chdesc}
$ chown -R _git:_git &#47;var&#47;git&#47;template
$ chmod +x $GIT_HOME&#47;template
$ chown -R _git:_git $WWW_HOME
</code></pre>

<p>Replacing <code>GIT_HOME</code> and <code>WWW_HOME</code> with the variables we configured previously in <code>config.rc</code>.</p>

<p>Finally we configure our <a href="https://man.openbsd.org/doas.conf">doas.conf(5)</a> to allow our main user to run these commands:</p>

<pre><code>permit nopass mite as _git cmd &#47;usr&#47;local&#47;bin&#47;stagit-newrepo
permit nopass mite as _git cmd &#47;usr&#47;local&#47;bin&#47;stagit-gen-index
permit nopass mite as _git cmd &#47;usr&#47;local&#47;bin&#47;stagit-chdesc
</code></pre>

<p>I&#8217;ve made a git repository for these scripts (and maybe a few more) available on <a href="https://github.com/e-zk/stagit-scripts">GitHub</a> which is mirrored on <a href="https://git.zakaria.org/stagit-scripts/log.html">git.zakaria.org</a></p>

<h2 id="httpd%20config">httpd config</h2>

<p>To actually serve the generated static files we need to configure <a href="https://man.openbsd.org/httpd">httpd(8)</a>. In <a href="https://man.openbsd.org/httpd.conf"><code>&#47;etc&#47;httpd.conf</code></a>:</p>

<pre><code>...snip...

server "git.zakaria.org" {
    listen on 127.0.0.1 on 8080

    # for letsencrypt
    location "&#47;.well-known&#47;acme-challenge&#47;*" {
        root "&#47;acme"
        request strip 2
    }

    root "&#47;htdocs&#47;git.zakaria.org"
}

...snip...
</code></pre>

<p>I use <a href="https://man.openbsd.org/relayd">relayd(8)</a> as a TLS proxy, so I don&#8217;t need to configure TLS certs in httpd.conf.</p>
</main>
<footer>
<br><hr>
<p>posted: [&nbsp;2022-02-14&nbsp;]</p>
<p>view: [&nbsp;<a href="/posts/stagit-setup.md">plaintext</a>&nbsp;|&nbsp;<a href="http://64wv2uqwjacqer7z5d6ooqgrvjwlioizmo7hgmxm7zxerbvgnoqhafid.onion/posts/stagit-setup.html">hidden service</a>&nbsp;]</p>
<div class="qrbox">
<details class="qr"><summary>show qr: [ clear net ]</summary> <svg width="3.92cm" height="3.92cm" viewBox="0 0 37 37" preserveAspectRatio="none" version="1.1" xmlns="http://www.w3.org/2000/svg">
	<g id="QRcode">
		<rect x="0" y="0" width="37" height="37" fill="#ffffff"/>
		<path style="stroke:#000000" transform="translate(4,4.5)" d="M0,0h7M9,0h3M13,0h1M17,0h1M22,0h7M0,1h1M6,1h1M11,1h2M14,1h1M17,1h2M20,1h1M22,1h1M28,1h1M0,2h1M2,2h3M6,2h1M9,2h3M14,2h3M19,2h2M22,2h1M24,2h3M28,2h1M0,3h1M2,3h3M6,3h1M8,3h1M10,3h2M13,3h1M17,3h1M19,3h2M22,3h1M24,3h3M28,3h1M0,4h1M2,4h3M6,4h1M8,4h1M10,4h1M12,4h1M14,4h1M16,4h1M19,4h2M22,4h1M24,4h3M28,4h1M0,5h1M6,5h1M9,5h2M16,5h1M22,5h1M28,5h1M0,6h7M8,6h1M10,6h1M12,6h1M14,6h1M16,6h1M18,6h1M20,6h1M22,6h7M9,7h1M12,7h1M16,7h1M18,7h1M0,8h2M5,8h3M9,8h2M12,8h2M15,8h1M17,8h1M20,8h1M24,8h2M2,9h1M4,9h1M8,9h1M10,9h1M13,9h3M19,9h1M21,9h1M23,9h2M26,9h2M0,10h1M2,10h2M6,10h2M9,10h1M11,10h8M20,10h2M23,10h2M0,11h3M5,11h1M10,11h2M15,11h1M19,11h2M22,11h1M24,11h2M0,12h2M4,12h1M6,12h5M15,12h1M18,12h1M20,12h1M22,12h2M28,12h1M1,13h2M5,13h1M7,13h1M10,13h1M12,13h2M15,13h5M22,13h3M27,13h2M1,14h7M9,14h2M15,14h3M20,14h4M25,14h2M0,15h5M8,15h3M12,15h1M14,15h1M19,15h1M21,15h2M26,15h1M28,15h1M1,16h1M3,16h2M6,16h3M12,16h3M17,16h1M25,16h2M0,17h1M8,17h3M14,17h2M19,17h2M22,17h3M26,17h3M0,18h2M4,18h4M10,18h1M12,18h2M15,18h2M18,18h5M24,18h2M28,18h1M0,19h1M4,19h1M8,19h1M10,19h2M16,19h1M19,19h1M21,19h1M24,19h1M0,20h1M6,20h1M8,20h2M11,20h1M13,20h5M20,20h5M26,20h3M8,21h2M12,21h4M19,21h2M24,21h2M0,22h7M8,22h1M10,22h1M14,22h3M19,22h2M22,22h1M24,22h3M0,23h1M6,23h1M8,23h1M12,23h1M14,23h1M18,23h3M24,23h1M27,23h2M0,24h1M2,24h3M6,24h1M11,24h2M16,24h1M19,24h7M27,24h1M0,25h1M2,25h3M6,25h1M10,25h1M13,25h1M15,25h2M18,25h3M25,25h2M28,25h1M0,26h1M2,26h3M6,26h1M11,26h2M14,26h3M18,26h10M0,27h1M6,27h1M8,27h1M10,27h2M14,27h2M21,27h1M25,27h2M28,27h1M0,28h7M8,28h2M11,28h2M15,28h1M17,28h1M19,28h1M21,28h2M25,28h2"/>
	</g>
</svg> </details>
<details class="qr"><summary>show qr: [ onion url ]</summary> <!-- Created with qrencode 4.1.1 (https://fukuchi.org/works/qrencode/index.html) -->
<svg width="4.76cm" height="4.76cm" viewBox="0 0 45 45" preserveAspectRatio="none" version="1.1" xmlns="http://www.w3.org/2000/svg">
	<g id="QRcode">
		<rect x="0" y="0" width="45" height="45" fill="#ffffff"/>
		<path style="stroke:#000000" transform="translate(4,4.5)" d="M0,0h7M9,0h1M14,0h1M16,0h6M23,0h1M25,0h1M28,0h1M30,0h7M0,1h1M6,1h1M8,1h2M11,1h2M14,1h2M17,1h1M20,1h3M24,1h2M27,1h1M30,1h1M36,1h1M0,2h1M2,2h3M6,2h1M9,2h3M14,2h3M18,2h5M24,2h1M28,2h1M30,2h1M32,2h3M36,2h1M0,3h1M2,3h3M6,3h1M8,3h2M11,3h1M13,3h7M22,3h2M25,3h4M30,3h1M32,3h3M36,3h1M0,4h1M2,4h3M6,4h1M10,4h1M12,4h1M14,4h1M16,4h8M26,4h1M28,4h1M30,4h1M32,4h3M36,4h1M0,5h1M6,5h1M8,5h1M10,5h1M15,5h3M20,5h1M24,5h4M30,5h1M36,5h1M0,6h7M8,6h1M10,6h1M12,6h1M14,6h1M16,6h1M18,6h1M20,6h1M22,6h1M24,6h1M26,6h1M28,6h1M30,6h7M12,7h1M15,7h2M21,7h1M23,7h2M26,7h1M0,8h5M6,8h5M12,8h2M15,8h1M17,8h1M19,8h1M22,8h2M25,8h5M31,8h1M33,8h1M35,8h1M0,9h1M4,9h1M7,9h2M13,9h1M16,9h1M19,9h3M23,9h1M25,9h1M28,9h2M31,9h1M34,9h1M1,10h1M4,10h3M8,10h1M11,10h6M18,10h1M26,10h3M30,10h3M34,10h1M36,10h1M0,11h1M2,11h1M4,11h2M7,11h1M10,11h2M18,11h4M23,11h1M28,11h3M33,11h1M0,12h7M11,12h1M13,12h5M19,12h1M22,12h1M25,12h3M29,12h2M32,12h3M2,13h1M5,13h1M10,13h1M12,13h2M16,13h10M28,13h1M31,13h1M34,13h2M0,14h5M6,14h1M15,14h3M20,14h1M22,14h1M27,14h5M34,14h1M36,14h1M1,15h5M8,15h3M12,15h1M15,15h2M19,15h3M26,15h2M29,15h2M33,15h1M36,15h1M0,16h1M2,16h1M4,16h4M9,16h2M12,16h3M17,16h1M19,16h1M22,16h9M32,16h1M34,16h1M36,16h1M0,17h3M4,17h1M10,17h1M14,17h1M19,17h3M23,17h1M25,17h1M28,17h2M31,17h1M35,17h1M0,18h1M2,18h2M5,18h3M10,18h3M14,18h2M17,18h2M22,18h1M24,18h5M30,18h1M32,18h5M2,19h1M5,19h1M9,19h3M15,19h2M19,19h4M24,19h1M26,19h1M28,19h1M32,19h2M36,19h1M2,20h2M5,20h2M8,20h1M11,20h1M13,20h5M19,20h1M22,20h2M25,20h2M30,20h1M32,20h1M34,20h3M0,21h3M4,21h1M8,21h1M10,21h1M12,21h2M16,21h1M19,21h1M23,21h1M25,21h1M28,21h2M31,21h1M35,21h1M0,22h3M4,22h1M6,22h4M14,22h3M22,22h1M27,22h7M35,22h2M2,23h2M8,23h1M10,23h1M12,23h1M14,23h2M18,23h1M20,23h2M26,23h1M28,23h2M31,23h1M36,23h1M5,24h3M9,24h2M12,24h3M17,24h1M22,24h5M29,24h4M34,24h3M0,25h1M3,25h3M7,25h3M13,25h1M16,25h1M19,25h2M23,25h1M25,25h2M28,25h2M31,25h1M35,25h1M0,26h1M2,26h1M5,26h4M10,26h3M14,26h5M20,26h1M22,26h1M25,26h1M27,26h1M31,26h1M34,26h3M0,27h1M4,27h2M7,27h5M16,27h1M21,27h3M28,27h1M36,27h1M0,28h1M3,28h1M5,28h3M11,28h1M15,28h1M17,28h3M22,28h1M24,28h9M34,28h1M8,29h3M12,29h2M16,29h8M25,29h1M28,29h1M32,29h1M0,30h7M8,30h2M13,30h5M21,30h1M24,30h1M26,30h1M28,30h1M30,30h1M32,30h5M0,31h1M6,31h1M9,31h2M12,31h2M15,31h1M19,31h4M24,31h1M26,31h3M32,31h2M35,31h2M0,32h1M2,32h3M6,32h1M8,32h2M12,32h1M14,32h2M17,32h1M22,32h11M34,32h2M0,33h1M2,33h3M6,33h1M8,33h3M16,33h1M19,33h2M23,33h1M25,33h1M27,33h1M30,33h4M35,33h2M0,34h1M2,34h3M6,34h1M8,34h5M15,34h1M17,34h2M20,34h2M25,34h2M29,34h1M31,34h1M33,34h4M0,35h1M6,35h1M8,35h2M11,35h1M14,35h3M21,35h1M23,35h1M26,35h6M36,35h1M0,36h7M8,36h1M11,36h1M15,36h3M22,36h1M25,36h1M29,36h3M34,36h3"/>
	</g>
</svg> </details>
</div>
(C) <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>
</footer>
</body>
</html>
