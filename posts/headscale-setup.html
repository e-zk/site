<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta content="#101010" name="theme-color"/>
<link href="/favicon.svg" rel="icon" sizes="any" type="image/svg+xml">
<link href="/favicon.ico" rel="alternate icon">
<link href="/static/css/main.css" rel="stylesheet">
<meta http-equiv="onion-location" content="http://64wv2uqwjacqer7z5d6ooqgrvjwlioizmo7hgmxm7zxerbvgnoqhafid.onion/posts/headscale-setup.html">
<title>Installing Headscale on OpenBSD</title>
<meta property="og:title" content="Installing Headscale on OpenBSD">
<meta property="og:description" content="In this post I'll detail the steps I took to install and configure headscale, an open-source self-hostable implementation of the Tailscale control server, on OpenBSD.">
</head>
<body>
<header>
<nav>
<a href="/">zakaria.org</a><a href="/posts/">posts</a><a href="/projects.html">code</a><a class="right" href="/about.html">about</a></nav>
</header>
<main>
<h1 id="Installing%20headscale%20on%20OpenBSD">Installing headscale on OpenBSD</h1>

<p>In this post I&#8217;ll detail the steps I took to install and configure
<a href="https://github.com/juanfont/headscale">headscale</a>, an open-source self-hostable implementation of the <a href="https://tailscale.com/">Tailscale</a> control server, on OpenBSD.</p>

<p>Code blocks prefixed with <code>#</code> imply that the command should be run as a privileged user&#47;root.</p>

<p>If you get stuck, it&#8217;ll be probably worthwhile to have a read of headscale&#8217;s documentation available in their GitHub repo: <a href="https://github.com/juanfont/headscale/tree/main/docs">https:&#47;&#47;github.com&#47;juanfont&#47;headscale&#47;tree&#47;main&#47;docs</a> .</p>

<h2 id="Compilation">Compilation</h2>

<p>Since my server is on OpenBSD-stable, headscale is only available via <code>pkg_add</code> on -current, I need to compile the headscale binary by hand and upload it to the server.
I&#8217;m doing this on an OpenBSD machine, so compiling and uploading it to the server
should be a breeze.</p>

<pre><code>$ git clone git@github.com:juanfont&#47;headscale.git
$ cd headscale
$ make generate
$ make build
$ sftp user@server &#60;&#60;EOF
&#62; put .&#47;headscale
&#62; bye
EOF
</code></pre>

<p>Then login, get root access, and copy the binary to <code>&#47;usr&#47;local&#47;bin</code>:</p>

<pre><code>$ ssh user@server
$ doas -s
...
# cp .&#47;headscale &#47;usr&#47;local&#47;bin
# chown root:bin &#47;usr&#47;local&#47;bin&#47;headscale
</code></pre>

<h2 id="Configuration">Configuration</h2>

<p>Next we need to setup:</p>

<ol>
<li>a <code>_headscale</code> daemon user that headscale will run as.</li>
<li>directories for headscale to store its sqlite database, private key, and socket (making sure they have the correct permissions&#47;owner).</li>
<li>copy the example config from GitHub, and edit it to our liking</li>
</ol>

<p>First we setup some directories:</p>

<pre><code># mkdir -p &#47;etc&#47;headscale
# touch &#47;etc&#47;headscale&#47;config.yaml
# mkdir -p &#47;var&#47;headscale
</code></pre>

<p>Then we add our <code>_headscale</code> daemon user, and <code>chown</code> all the necessary dirs.<br/>
Here we also run <code>doas</code> to get us a shell as <code>_headscale</code> so I can create the db.sqlite file. Note doing it this way requires some <code>doas.conf</code> rules.</p>

<pre><code># useradd -L daemon -s &#47;sbin&#47;nologin -d &#47;var&#47;headscale _headscale
# chown -R _headscale:_headscale &#47;var&#47;headscale 
# doas -u _headscale &#47;bin&#47;ksh
$ touch &#47;var&#47;headscale&#47;db.sqlite
</code></pre>

<p>Finally we can edit the headscale config. I highly recommend copying the <a href="https://raw.githubusercontent.com/juanfont/headscale/main/config-example.yaml">example config</a> and using that as a starting point.</p>

<pre><code># vi &#47;etc&#47;headscale&#47;config.yaml
# # copy the example config
# # change domain, IPs, ports
# # change sock location to &#47;var&#47;headscale&#47;headscale.sock 
</code></pre>

<p>I&#8217;m currently using <a href="https://man.openbsd.org/relayd">relayd(8)</a> as a TLS proxy, so I don&#8217;t need to
configure any TLS-related stuff.</p>

<p>Run <code>headscale serve</code> to see if the config works, and all the directories and permissions are correct:</p>

<pre><code># doas -u _headscale headscale serve
...
</code></pre>

<p>If all is well we can move onto setting up an init script for the headscale daemon.</p>

<h2 id="rc.d">rc.d</h2>

<p>I&#8217;ve made an init script to making stopping&#47;starting and running at boot
a lot easier. Drop this simple script into <code>&#47;etc&#47;rc.d&#47;headscale</code>:</p>

<pre><code>#!&#47;bin&#47;ksh
#
# &#47;etc&#47;rc.d&#47;headscale

daemon_user="_headscale"
daemon="&#47;usr&#47;local&#47;bin&#47;headscale"
daemon_flags="serve"

. &#47;etc&#47;rc.d&#47;rc.subr

rc_cmd $1
</code></pre>

<p><code>chmod</code>, enable and start it as usual:</p>

<pre><code># chmod +x &#47;etc&#47;rc.d&#47;headscale
# rcctl enable headscale
# rcctl start headscale
headscale(ok)
</code></pre>

<h2 id="Clients">Clients</h2>

<p>So here&#8217;s where you may run into some problems. Depending on the OS your client is going to be running on, it might be a little difficult to get Tailscale to use your custom control server. On Android, this editing the hardcoded Tailscale control server URL, and compiling the client from source.</p>

<h3 id="OpenBSD%20client">OpenBSD client</h3>

<p>It&#8217;s pretty easy to get the Tailscale client on OpenBSD to use your control server. </p>

<pre><code># pkg_add tailscale
# rcctl enable tailscaled; rcctl start tailscaled
# tailscale --login-server "https:&#47;&#47;headscale.example.com:443"
...
</code></pre>

<p>Where <code>https:&#47;&#47;headscale.example.com:443</code> is your control server URL.</p>

<h3 id="Android%20client">Android client</h3>

<p>You can find the instructions for patching and building the custom APK <a href="https://github.com/juanfont/headscale/issues/58#issuecomment-950386833">here</a>.</p>

<p>I didn&#8217;t bother even attempting to install the android sdk, ndk, and all the other required (garbage) on OpenBSD to compile the Android client. So I booted into Windows, then logged into Ubuntu on WSL, then had to install Go manually (since Ubuntu 20.04 packages are old AF and I can&#8217;t be bothered to move all the junk I&#8217;ve accumulated in my WSL distro&#8217;s $HOME). Then i installed the sdkmanager manually, then i installed the ndk through that manually, then I ran <code>make tailscale-debug.apk</code>.</p>

<p>Quite frankly this was painful, but it isn&#8217;t supposed to be. Wrangling with old documentation I found online about installing the android sdk on the outdated WSL Ubuntu setup I have set me back a few hours.</p>

<p>In the end it was quite rewarding to install the APK file, open it up and see it all working!</p>
</main>
<footer>
<br><hr>
<p>posted: [&nbsp;2022-02-15&nbsp;]</p>
<p>view: [&nbsp;<a href="/posts/headscale-setup.md">plaintext</a>&nbsp;|&nbsp;<a href="http://64wv2uqwjacqer7z5d6ooqgrvjwlioizmo7hgmxm7zxerbvgnoqhafid.onion/posts/headscale-setup.html">hidden service</a>&nbsp;]</p>
<div class="qrbox">
<details class="qr"><summary>show qr: [ clear net ]</summary> <svg width="3.92cm" height="3.92cm" viewBox="0 0 37 37" preserveAspectRatio="none" version="1.1" xmlns="http://www.w3.org/2000/svg">
	<g id="QRcode">
		<rect x="0" y="0" width="37" height="37" fill="#ffffff"/>
		<path style="stroke:#000000" transform="translate(4,4.5)" d="M0,0h7M10,0h1M12,0h1M14,0h1M16,0h1M19,0h2M22,0h7M0,1h1M6,1h1M8,1h1M10,1h1M13,1h1M15,1h4M20,1h1M22,1h1M28,1h1M0,2h1M2,2h3M6,2h1M12,2h1M14,2h3M19,2h2M22,2h1M24,2h3M28,2h1M0,3h1M2,3h3M6,3h1M8,3h3M12,3h3M17,3h1M19,3h1M22,3h1M24,3h3M28,3h1M0,4h1M2,4h3M6,4h1M9,4h1M19,4h2M22,4h1M24,4h3M28,4h1M0,5h1M6,5h1M8,5h2M11,5h2M14,5h3M22,5h1M28,5h1M0,6h7M8,6h1M10,6h1M12,6h1M14,6h1M16,6h1M18,6h1M20,6h1M22,6h7M9,7h3M14,7h3M18,7h1M0,8h5M6,8h4M11,8h1M13,8h3M17,8h1M20,8h2M23,8h1M25,8h1M27,8h1M2,9h2M5,9h1M7,9h1M10,9h1M12,9h1M14,9h1M16,9h1M19,9h2M22,9h3M28,9h1M0,10h2M6,10h3M10,10h1M14,10h2M17,10h2M20,10h2M23,10h2M0,11h1M2,11h1M4,11h2M8,11h1M12,11h1M15,11h2M19,11h4M24,11h2M27,11h1M3,12h4M8,12h3M12,12h3M17,12h3M25,12h2M0,13h4M5,13h1M9,13h1M14,13h1M16,13h4M21,13h4M28,13h1M3,14h1M5,14h3M10,14h3M14,14h4M20,14h4M25,14h2M1,15h1M3,15h2M7,15h1M9,15h3M14,15h2M19,15h2M27,15h1M0,16h1M2,16h1M6,16h1M8,16h1M10,16h6M17,16h1M25,16h2M0,17h2M3,17h1M8,17h2M12,17h1M14,17h1M16,17h9M26,17h1M28,17h1M0,18h1M2,18h1M4,18h1M6,18h3M10,18h1M12,18h1M15,18h2M18,18h1M21,18h1M23,18h2M26,18h1M0,19h1M2,19h2M7,19h3M18,19h2M24,19h1M27,19h1M0,20h1M2,20h1M5,20h3M9,20h1M11,20h3M15,20h1M17,20h1M20,20h5M26,20h3M8,21h2M11,21h1M13,21h1M16,21h1M18,21h3M24,21h5M0,22h7M8,22h3M13,22h4M19,22h2M22,22h1M24,22h3M0,23h1M6,23h1M19,23h2M24,23h1M27,23h2M0,24h1M2,24h3M6,24h1M8,24h1M10,24h8M20,24h5M26,24h1M28,24h1M0,25h1M2,25h3M6,25h1M8,25h4M13,25h1M16,25h1M18,25h4M25,25h4M0,26h1M2,26h3M6,26h1M8,26h1M10,26h1M12,26h1M15,26h1M18,26h10M0,27h1M6,27h1M8,27h2M15,27h2M20,27h1M22,27h1M25,27h1M27,27h1M0,28h7M8,28h3M13,28h3M17,28h1M19,28h1M21,28h2M25,28h2"/>
	</g>
</svg> </details>
<details class="qr"><summary>show qr: [ onion url ]</summary> <!-- Created with qrencode 4.1.1 (https://fukuchi.org/works/qrencode/index.html) -->
<svg width="4.76cm" height="4.76cm" viewBox="0 0 45 45" preserveAspectRatio="none" version="1.1" xmlns="http://www.w3.org/2000/svg">
	<g id="QRcode">
		<rect x="0" y="0" width="45" height="45" fill="#ffffff"/>
		<path style="stroke:#000000" transform="translate(4,4.5)" d="M0,0h7M10,0h1M12,0h1M14,0h1M16,0h6M23,0h1M25,0h1M28,0h1M30,0h7M0,1h1M6,1h1M8,1h1M10,1h1M13,1h1M15,1h3M20,1h3M24,1h2M27,1h1M30,1h1M36,1h1M0,2h1M2,2h3M6,2h1M12,2h1M14,2h3M18,2h5M24,2h1M28,2h1M30,2h1M32,2h3M36,2h1M0,3h1M2,3h3M6,3h1M8,3h3M12,3h3M17,3h3M22,3h2M25,3h4M30,3h1M32,3h3M36,3h1M0,4h1M2,4h3M6,4h1M9,4h1M17,4h7M26,4h1M28,4h1M30,4h1M32,4h3M36,4h1M0,5h1M6,5h1M8,5h2M11,5h2M14,5h4M20,5h1M24,5h4M30,5h1M36,5h1M0,6h7M8,6h1M10,6h1M12,6h1M14,6h1M16,6h1M18,6h1M20,6h1M22,6h1M24,6h1M26,6h1M28,6h1M30,6h7M9,7h3M14,7h3M21,7h1M23,7h2M26,7h1M0,8h5M6,8h4M11,8h1M13,8h3M17,8h1M19,8h1M22,8h2M25,8h5M31,8h1M33,8h1M35,8h1M1,9h1M7,9h1M10,9h1M12,9h1M14,9h1M16,9h1M19,9h3M23,9h1M25,9h1M28,9h2M31,9h1M34,9h1M0,10h1M2,10h1M5,10h4M14,10h2M18,10h1M26,10h3M30,10h3M34,10h1M36,10h1M0,11h1M2,11h1M9,11h2M12,11h1M15,11h2M18,11h4M23,11h1M28,11h3M33,11h1M0,12h3M6,12h2M9,12h1M12,12h3M17,12h1M19,12h1M22,12h1M25,12h3M29,12h2M32,12h3M0,13h2M3,13h2M7,13h4M14,13h1M16,13h10M28,13h1M31,13h1M34,13h2M0,14h4M5,14h2M10,14h3M14,14h4M20,14h1M22,14h1M27,14h5M34,14h1M36,14h1M0,15h2M3,15h3M7,15h2M11,15h1M14,15h2M19,15h3M26,15h2M29,15h2M33,15h1M36,15h1M2,16h2M5,16h2M8,16h1M11,16h1M13,16h3M17,16h1M19,16h1M22,16h9M32,16h1M34,16h1M36,16h1M3,17h2M9,17h2M12,17h1M14,17h1M16,17h1M19,17h3M23,17h1M25,17h1M28,17h2M31,17h1M35,17h1M0,18h11M15,18h4M22,18h1M24,18h5M30,18h1M32,18h5M2,19h2M8,19h2M12,19h1M19,19h4M24,19h1M26,19h1M28,19h1M32,19h2M36,19h1M1,20h1M3,20h1M5,20h4M12,20h2M15,20h1M17,20h1M19,20h1M22,20h2M25,20h2M30,20h1M32,20h1M34,20h3M0,21h1M2,21h1M5,21h1M7,21h2M10,21h1M13,21h1M16,21h1M19,21h1M23,21h1M25,21h1M28,21h2M31,21h1M35,21h1M0,22h3M6,22h3M10,22h7M22,22h1M27,22h7M35,22h2M0,23h3M8,23h1M10,23h2M18,23h1M20,23h2M26,23h1M28,23h2M31,23h1M36,23h1M0,24h1M3,24h1M6,24h2M9,24h3M13,24h5M22,24h5M29,24h4M34,24h3M0,25h2M4,25h1M9,25h1M12,25h2M16,25h1M19,25h2M23,25h1M25,25h2M28,25h2M31,25h1M35,25h1M0,26h1M4,26h4M10,26h1M15,26h1M17,26h2M20,26h1M22,26h1M25,26h1M27,26h1M31,26h1M34,26h3M0,27h1M2,27h3M12,27h1M15,27h2M21,27h3M28,27h1M36,27h1M0,28h1M3,28h2M6,28h2M12,28h4M17,28h3M22,28h1M24,28h9M34,28h1M8,29h3M14,29h1M16,29h8M25,29h1M28,29h1M32,29h1M0,30h7M8,30h5M14,30h4M21,30h1M24,30h1M26,30h1M28,30h1M30,30h1M32,30h5M0,31h1M6,31h1M10,31h2M15,31h1M19,31h4M24,31h1M26,31h3M32,31h2M36,31h1M0,32h1M2,32h3M6,32h1M8,32h8M17,32h1M22,32h11M34,32h1M36,32h1M0,33h1M2,33h3M6,33h1M8,33h3M12,33h2M16,33h5M23,33h1M25,33h1M27,33h1M30,33h4M0,34h1M2,34h3M6,34h1M8,34h1M12,34h1M14,34h3M18,34h1M20,34h2M25,34h2M29,34h1M31,34h1M33,34h4M0,35h1M6,35h1M8,35h3M14,35h3M18,35h1M21,35h1M23,35h1M26,35h6M36,35h1M0,36h7M8,36h1M10,36h6M17,36h1M22,36h1M25,36h1M29,36h3M34,36h3"/>
	</g>
</svg> </details>
</div>
(C) <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>
</footer>
</body>
</html>
