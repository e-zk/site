<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta content="#101010" name="theme-color"/>
<link href="/favicon.svg" rel="icon" sizes="any" type="image/svg+xml">
<link href="/favicon.ico" rel="alternate icon">
<link href="/static/css/main.css" rel="stylesheet">
<meta http-equiv="onion-location" content="http://g5hwwozzm3co43bu6np2noyhsju7zuok3cqawlbeo4entvfoads5trqd.onion/posts/2020-12-08-openbsd-notes.html">
<title>OpenBSD Notes</title>
<meta property="og:title" content="OpenBSD Notes">
<meta property="og:description" content="Random notes for running OpenBSD on a laptop">
</head>
<body>
<header>
<nav>
<a href="/">zakaria.org</a><a href="/posts/">posts</a><a href="/about.html">about</a>
</nav>
</header>
<main>
<h1 id="OpenBSD%20notes">OpenBSD notes</h1>

<p>Random notes on running <a href="https://openbsd.org/">OpenBSD</a> (some notes may only be useful for a laptop install). Updated frequently.</p>

<h2 id="Table%20of%20Contents">Table of Contents</h2>

<ul>
<li><a href="#Power%2fBattery">Power&#47;Battery</a>

<ul>
<li><a href="#Hibernate%20on%20low%20battery">Hibernate on low battery</a></li>
<li><a href="#User%20power%20commands">User power commands</a></li>
</ul></li>
<li><a href="#Multimedia">Multimedia</a>

<ul>
<li><a href="#Microphone%20Setup">Microphone Setup</a></li>
</ul></li>
<li><a href="#X">X</a></li>
<li><a href="#PF">PF</a>

<ul>
<li><a href="#Standard%20preamble">Standard preamble</a></li>
<li><a href="#Allow%20NTP">Allow NTP</a></li>
<li><a href="#VMs">VMs</a></li>
</ul></li>
<li><a href="#Misc">Misc</a></li>
<li><a href="#Manual%20pages%20as%20beautifully%20typeset%20PDFs">Manual pages as beautifully typeset PDFs</a></li>
</ul>

<h2 id="Power&amp;#47;Battery">Power&#47;Battery</h2>

<h3 id="Hibernate%20on%20low%20battery">Hibernate on low battery</h3>

<p>To hibernate at 5% remaining battery add in <code>&#47;etc&#47;rc.conf.local</code>:</p>

<pre><code class="language-bash">apmd_flags=-A -Z 5
</code></pre>

<h3 id="User%20power%20commands">User power commands</h3>

<p>In <code>&#47;etc&#47;doas.conf</code>:</p>

<pre><code>permit nopass :staff as root cmd zzz
permit nopass :staff as root cmd ZZZ
permit nopass :staff as root cmd reboot args
permit nopass :staff as root cmd shutdown args -p now
</code></pre>

<h2 id="Multimedia">Multimedia</h2>

<h3 id="Microphone%20setup">Microphone setup</h3>

<p>I have a fancy microphone that has a headphone passthrough. So it is both USB &#8220;speaker&#8221; and a USB microphone. Good news, that makes using it with sndio a <em>bit</em> easier.</p>

<p>Change primary sndiod device to the microphone (check dmesg for <code>audio[0-9]</code> device id):</p>

<pre><code># rcctl set sndiod flags -f rsnd&#47;1
# rcctl restart sndiod
</code></pre>

<p>Switch mixer sources:</p>

<pre><code># mixerctl outputs.hp_source=dac-2:3
outputs.hp_source: dac-0:1 -&#62; dac-2:3
</code></pre>

<p>To switch back, remove the sndiod flag, and change the source back to it&#8217;s original value (<code>dac-0:1</code>).</p>

<h2 id="X">X</h2>

<p>See <a href="/posts/2021-01-04-xenodm.html">full post</a> for xenodm themeing.</p>

<h2 id="PF">PF</h2>

<p>Packet Filter (firewall). General stuff to remember:</p>

<ul>
<li>last rule &#8216;wins&#8217;*</li>
<li><code>egress</code> = interface(s) that hold the default route(s)</li>
</ul>

<h3 id="Standard%20preamble">Standard preamble</h3>

<pre><code># options 
set block-policy drop
set skip on lo

# default deny
block all 

# antispoofing
antispoof for egress
antispoof for $vm_int
</code></pre>

<h3 id="Allow%20NTP">Allow NTP</h3>

<p>In rare cases ntp can use tcp apparently&#8230;</p>

<pre><code>pass quick inet proto { tcp, udp } to port ntp
</code></pre>

<h3 id="VMs">VMs</h3>

<p>Don&#8217;t forget to <code>sysctl net.inet.ip.forwarding=1</code>!</p>

<pre><code># where:
# vm_int        = vm interface (vether[0-9])
# vm_dns_server = dns server to be used by vms

# allow ssh traffic to vm
pass out on $vm_int proto tcp to $vm_int:network port 22

# vm nat
match out on egress from $vm_int:network to any nat-to (egress)
pass in proto { tcp udp } from $vm_int:network to any port domain \
        rdr-to $vm_dns_server port domain

# allow icmp + web from vms
pass in on $vm_int proto icmp
pass in on $vm_int proto tcp to port { www, https }

# only allow X11 forwarding on the vm interface
pass in on $vm_int proto tcp to port 6000:6010
</code></pre>

<h2 id="Misc">Misc</h2>

<h3 id="Manual%20pages%20as%20beautifully%20typeset%20PDFs">Manual pages as beautifully typeset PDFs</h3>

<pre><code class="language-console">$ MANPAGER=zathura man -T pdf style
</code></pre>
</main>
<footer>
OpenBSD Notes&nbsp;&sdot;&nbsp;2020-12-08&nbsp;&sdot;&nbsp;<a href="./2020-12-08-openbsd-notes.md">Plaintext</a>&nbsp;&sdot;&nbsp;<a href="http://g5hwwozzm3co43bu6np2noyhsju7zuok3cqawlbeo4entvfoads5trqd.onion/posts/2020-12-08-openbsd-notes.html" title="Tor">Onion</a>&nbsp;&sdot;&nbsp;&copy; Zakaria <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></footer>
</body>
</html>
