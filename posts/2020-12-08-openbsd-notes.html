<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta content="#101010" name="theme-color"/>
<link href="/favicon.svg" rel="icon" sizes="any" type="image/svg+xml">
<link href="/favicon.ico" rel="alternate icon">
<link href="/static/css/main.css" rel="stylesheet">
<meta http-equiv="onion-location" content="http://64wv2uqwjacqer7z5d6ooqgrvjwlioizmo7hgmxm7zxerbvgnoqhafid.onion/posts/2020-12-08-openbsd-notes.html">
<title>OpenBSD Notes</title>
<meta property="og:title" content="OpenBSD Notes">
<meta property="og:description" content="Random notes for running OpenBSD on a laptop">
</head>
<body>
<header>
<nav>
<a href="/">zakaria.org</a><a href="/posts/">posts</a><a href="/projects.html">code</a><a style="float:right" href="/about.html">about</a></nav>
</header>
<main>
<h1 id="OpenBSD%20notes">OpenBSD notes</h1>

<p>Random notes on running <a href="https://openbsd.org/">OpenBSD</a> (some notes may only be useful for a laptop install). Updated frequently.</p>

<h2 id="Table%20of%20Contents">Table of Contents</h2>

<ul>
<li><a href="#Power%2fBattery">Power&#47;Battery</a>

<ul>
<li><a href="#Hibernate%20on%20low%20battery">Hibernate on low battery</a></li>
<li><a href="#User%20power%20commands">User power commands</a></li>
</ul></li>
<li><a href="#Multimedia">Multimedia</a>

<ul>
<li><a href="#Microphone%20Setup">Microphone Setup</a></li>
</ul></li>
<li><a href="#X">X</a></li>
<li><a href="#PF">PF</a>

<ul>
<li><a href="#Standard%20preamble">Standard preamble</a></li>
<li><a href="#Allow%20NTP">Allow NTP</a></li>
<li><a href="#VMs">VMs</a></li>
</ul></li>
<li><a href="#Misc">Misc</a></li>
<li><a href="#Manual%20pages%20as%20beautifully%20typeset%20PDFs">Manual pages as beautifully typeset PDFs</a></li>
</ul>

<h2 id="Power&amp;#47;Battery">Power&#47;Battery</h2>

<h3 id="Hibernate%20on%20low%20battery">Hibernate on low battery</h3>

<p>To hibernate at 5% remaining battery add in <code>&#47;etc&#47;rc.conf.local</code>:</p>

<pre><code class="language-bash">apmd_flags=-A -Z 5
</code></pre>

<h3 id="User%20power%20commands">User power commands</h3>

<p>In <code>&#47;etc&#47;doas.conf</code>:</p>

<pre><code>permit nopass :staff as root cmd zzz
permit nopass :staff as root cmd ZZZ
permit nopass :staff as root cmd reboot args
permit nopass :staff as root cmd shutdown args -p now
</code></pre>

<h2 id="Multimedia">Multimedia</h2>

<h3 id="Microphone%20setup">Microphone setup</h3>

<p>I have a fancy microphone that has a headphone passthrough. So it is both USB &#8220;speaker&#8221; and a USB microphone. Good news, that makes using it with sndio a <em>bit</em> easier.</p>

<p>Change primary sndiod device to the microphone (check dmesg for <code>audio[0-9]</code> device id):</p>

<pre><code># rcctl set sndiod flags -f rsnd&#47;1
# rcctl restart sndiod
</code></pre>

<p>Switch mixer sources:</p>

<pre><code># mixerctl outputs.hp_source=dac-2:3
outputs.hp_source: dac-0:1 -&#62; dac-2:3
</code></pre>

<p>To switch back, remove the sndiod flag, and change the source back to it&#8217;s original value (<code>dac-0:1</code>).</p>

<h2 id="X">X</h2>

<p>See <a href="/posts/2021-01-04-xenodm.html">full post</a> for xenodm themeing.</p>

<h2 id="PF">PF</h2>

<p>Packet Filter (firewall). General stuff to remember:</p>

<ul>
<li>last rule &#8216;wins&#8217;*</li>
<li><code>egress</code> = interface(s) that hold the default route(s)</li>
</ul>

<h3 id="Standard%20preamble">Standard preamble</h3>

<pre><code># options 
set block-policy drop
set skip on lo

# default deny
block all 

# antispoofing
antispoof for egress
antispoof for $vm_int
</code></pre>

<h3 id="Allow%20NTP">Allow NTP</h3>

<p>In rare cases ntp can use tcp apparently&#8230;</p>

<pre><code>pass quick inet proto { tcp, udp } to port ntp
</code></pre>

<h3 id="VMs">VMs</h3>

<p>Don&#8217;t forget to <code>sysctl net.inet.ip.forwarding=1</code>!</p>

<pre><code># where:
# vm_int        = vm interface (vether[0-9])
# vm_dns_server = dns server to be used by vms

# allow ssh traffic to vm
pass out on $vm_int proto tcp to $vm_int:network port 22

# vm nat
match out on egress from $vm_int:network to any nat-to (egress)
pass in proto { tcp udp } from $vm_int:network to any port domain \
        rdr-to $vm_dns_server port domain

# allow icmp + web from vms
pass in on $vm_int proto icmp
pass in on $vm_int proto tcp to port { www, https }

# only allow X11 forwarding on the vm interface
pass in on $vm_int proto tcp to port 6000:6010
</code></pre>

<h2 id="Misc">Misc</h2>

<h3 id="Manual%20pages%20as%20beautifully%20typeset%20PDFs">Manual pages as beautifully typeset PDFs</h3>

<pre><code class="language-console">$ MANPAGER=zathura man -T pdf style
</code></pre>
</main>
<footer>
<br><hr>
<p>posted: [&nbsp;2020-12-08&nbsp;]</p>
<p>view: [&nbsp;<a href="/posts/2020-12-08-openbsd-notes.md">plaintext</a>&nbsp;|&nbsp;<a href="http://64wv2uqwjacqer7z5d6ooqgrvjwlioizmo7hgmxm7zxerbvgnoqhafid.onion/posts/2020-12-08-openbsd-notes.html">hidden service</a>&nbsp;]</p>
<div class="qrbox">
<details class="qr"><summary>show qr: [ clear net ]</summary> <svg width="4.34cm" height="4.34cm" viewBox="0 0 41 41" preserveAspectRatio="none" version="1.1" xmlns="http://www.w3.org/2000/svg">
	<g id="QRcode">
		<rect x="0" y="0" width="41" height="41" fill="#ffffff"/>
		<path style="stroke:#000000" transform="translate(4,4.5)" d="M0,0h7M8,0h3M12,0h1M18,0h3M22,0h1M24,0h1M26,0h7M0,1h1M6,1h1M8,1h3M16,1h1M20,1h1M23,1h1M26,1h1M32,1h1M0,2h1M2,2h3M6,2h1M8,2h1M10,2h2M13,2h1M15,2h2M18,2h1M20,2h2M24,2h1M26,2h1M28,2h3M32,2h1M0,3h1M2,3h3M6,3h1M8,3h2M11,3h1M14,3h3M19,3h1M21,3h3M26,3h1M28,3h3M32,3h1M0,4h1M2,4h3M6,4h1M13,4h2M16,4h3M23,4h1M26,4h1M28,4h3M32,4h1M0,5h1M6,5h1M8,5h1M11,5h5M19,5h2M24,5h1M26,5h1M32,5h1M0,6h7M8,6h1M10,6h1M12,6h1M14,6h1M16,6h1M18,6h1M20,6h1M22,6h1M24,6h1M26,6h7M9,7h1M12,7h1M14,7h1M18,7h6M0,8h2M4,8h3M11,8h1M13,8h4M20,8h1M22,8h1M24,8h1M27,8h1M29,8h4M0,9h1M4,9h2M8,9h3M12,9h1M17,9h3M23,9h3M30,9h1M1,10h1M4,10h1M6,10h1M11,10h5M17,10h2M21,10h6M28,10h1M30,10h2M0,11h4M7,11h1M10,11h2M13,11h1M15,11h2M18,11h1M20,11h1M22,11h1M26,11h4M1,12h1M3,12h1M6,12h1M10,12h1M12,12h2M17,12h1M20,12h2M26,12h1M28,12h2M31,12h2M3,13h1M13,13h2M16,13h4M23,13h1M25,13h1M27,13h1M0,14h2M4,14h1M6,14h1M9,14h1M16,14h1M18,14h4M23,14h1M25,14h2M28,14h4M2,15h1M7,15h2M12,15h1M14,15h1M20,15h8M29,15h1M0,16h1M3,16h4M8,16h4M13,16h3M18,16h1M20,16h1M26,16h1M28,16h1M32,16h1M1,17h3M5,17h1M9,17h1M12,17h1M17,17h2M20,17h1M22,17h2M27,17h1M29,17h1M1,18h4M6,18h1M9,18h11M23,18h2M27,18h1M30,18h2M0,19h1M9,19h3M13,19h1M15,19h2M20,19h1M26,19h4M0,20h4M5,20h4M12,20h2M17,20h2M20,20h3M26,20h3M32,20h1M0,21h3M8,21h1M13,21h2M17,21h4M22,21h2M25,21h1M27,21h1M29,21h1M2,22h2M5,22h2M10,22h1M18,22h1M22,22h4M28,22h1M30,22h2M4,23h1M8,23h2M12,23h1M14,23h2M17,23h1M19,23h3M24,23h5M0,24h3M6,24h2M10,24h2M13,24h3M17,24h1M20,24h1M22,24h8M31,24h1M8,25h2M12,25h1M15,25h1M18,25h1M22,25h1M24,25h1M28,25h1M31,25h1M0,26h7M9,26h1M11,26h4M17,26h4M22,26h1M24,26h1M26,26h1M28,26h4M0,27h1M6,27h1M8,27h2M11,27h1M13,27h1M15,27h1M18,27h1M20,27h2M24,27h1M28,27h1M31,27h1M0,28h1M2,28h3M6,28h1M8,28h1M10,28h1M12,28h2M15,28h1M20,28h2M24,28h5M31,28h1M0,29h1M2,29h3M6,29h1M9,29h2M13,29h2M17,29h3M24,29h3M28,29h1M30,29h1M32,29h1M0,30h1M2,30h3M6,30h1M16,30h3M22,30h2M26,30h1M28,30h1M0,31h1M6,31h1M8,31h1M10,31h1M12,31h1M14,31h1M17,31h3M22,31h1M24,31h3M0,32h7M8,32h4M13,32h3M18,32h3M23,32h2M28,32h1M32,32h1"/>
	</g>
</svg> </details>
<details class="qr"><summary>show qr: [ onion url ]</summary> <!-- Created with qrencode 4.1.1 (https://fukuchi.org/works/qrencode/index.html) -->
<svg width="4.76cm" height="4.76cm" viewBox="0 0 45 45" preserveAspectRatio="none" version="1.1" xmlns="http://www.w3.org/2000/svg">
	<g id="QRcode">
		<rect x="0" y="0" width="45" height="45" fill="#ffffff"/>
		<path style="stroke:#000000" transform="translate(4,4.5)" d="M0,0h7M9,0h1M12,0h2M15,0h7M23,0h1M25,0h1M28,0h1M30,0h7M0,1h1M6,1h1M8,1h2M11,1h1M14,1h2M17,1h1M20,1h3M24,1h2M27,1h1M30,1h1M36,1h1M0,2h1M2,2h3M6,2h1M9,2h1M13,2h2M18,2h5M24,2h1M28,2h1M30,2h1M32,2h3M36,2h1M0,3h1M2,3h3M6,3h1M8,3h2M11,3h5M17,3h3M22,3h2M25,3h4M30,3h1M32,3h3M36,3h1M0,4h1M2,4h3M6,4h1M11,4h3M15,4h1M17,4h7M26,4h1M28,4h1M30,4h1M32,4h3M36,4h1M0,5h1M6,5h1M8,5h1M10,5h2M13,5h2M17,5h1M20,5h1M24,5h4M30,5h1M36,5h1M0,6h7M8,6h1M10,6h1M12,6h1M14,6h1M16,6h1M18,6h1M20,6h1M22,6h1M24,6h1M26,6h1M28,6h1M30,6h7M21,7h1M23,7h2M26,7h1M0,8h5M6,8h7M15,8h1M17,8h1M19,8h1M22,8h2M25,8h5M31,8h1M33,8h1M35,8h1M1,9h1M4,9h2M7,9h1M9,9h1M12,9h2M19,9h3M23,9h1M25,9h1M28,9h2M31,9h1M34,9h1M0,10h3M6,10h1M11,10h2M14,10h3M18,10h1M26,10h3M30,10h3M34,10h1M36,10h1M0,11h1M4,11h1M7,11h2M10,11h2M13,11h1M18,11h4M23,11h1M28,11h3M33,11h1M1,12h2M5,12h2M11,12h3M15,12h3M19,12h1M22,12h1M25,12h3M29,12h2M32,12h3M1,13h4M12,13h2M15,13h11M28,13h1M31,13h1M34,13h2M2,14h3M6,14h2M10,14h1M14,14h4M20,14h1M22,14h1M27,14h5M34,14h1M36,14h1M1,15h1M3,15h2M7,15h1M9,15h2M13,15h2M19,15h3M26,15h2M29,15h2M33,15h1M36,15h1M0,16h1M2,16h1M6,16h1M8,16h1M10,16h3M14,16h4M19,16h1M22,16h9M32,16h1M34,16h1M36,16h1M0,17h3M5,17h1M9,17h1M13,17h1M16,17h1M19,17h3M23,17h1M25,17h1M28,17h2M31,17h1M35,17h1M6,18h1M8,18h1M11,18h1M14,18h1M16,18h3M22,18h1M24,18h5M30,18h1M32,18h5M1,19h2M4,19h1M8,19h3M16,19h1M19,19h4M24,19h1M26,19h1M28,19h1M32,19h2M36,19h1M1,20h1M5,20h2M8,20h1M12,20h1M14,20h4M19,20h1M22,20h2M25,20h2M30,20h1M32,20h1M34,20h3M0,21h2M3,21h3M9,21h3M13,21h1M15,21h1M19,21h1M23,21h1M25,21h1M28,21h2M31,21h1M35,21h1M1,22h3M5,22h3M9,22h2M12,22h4M22,22h1M27,22h7M35,22h2M0,23h1M2,23h2M5,23h1M8,23h1M11,23h1M15,23h2M18,23h1M20,23h2M26,23h1M28,23h2M31,23h1M36,23h1M5,24h4M10,24h6M17,24h1M22,24h5M29,24h4M34,24h3M0,25h5M7,25h7M19,25h2M23,25h1M25,25h2M28,25h2M31,25h1M35,25h1M0,26h1M2,26h6M10,26h3M14,26h1M17,26h2M20,26h1M22,26h1M25,26h1M27,26h1M31,26h1M34,26h3M0,27h1M2,27h1M13,27h1M15,27h1M21,27h3M28,27h1M36,27h1M0,28h1M2,28h5M11,28h2M15,28h1M17,28h3M22,28h1M24,28h9M34,28h1M8,29h2M12,29h1M15,29h2M18,29h6M25,29h1M28,29h1M32,29h1M0,30h7M8,30h2M11,30h2M14,30h2M18,30h1M21,30h1M24,30h1M26,30h1M28,30h1M30,30h1M32,30h5M0,31h1M6,31h1M10,31h2M13,31h3M18,31h5M24,31h1M26,31h3M32,31h2M35,31h1M0,32h1M2,32h3M6,32h1M8,32h2M11,32h3M15,32h1M17,32h1M22,32h11M34,32h1M0,33h1M2,33h3M6,33h1M8,33h1M11,33h1M13,33h1M15,33h1M18,33h3M23,33h1M25,33h1M27,33h1M30,33h4M36,33h1M0,34h1M2,34h3M6,34h1M8,34h1M11,34h1M14,34h4M20,34h2M25,34h2M29,34h1M31,34h1M33,34h4M0,35h1M6,35h1M8,35h3M13,35h3M17,35h1M21,35h1M23,35h1M26,35h6M36,35h1M0,36h7M8,36h2M11,36h2M14,36h3M18,36h1M22,36h1M25,36h1M29,36h3M34,36h3"/>
	</g>
</svg> </details>
</div>
(C) <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>
</footer>
</body>
</html>
