<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta content="#101010" name="theme-color"/>
<link href="/favicon.svg" rel="icon" sizes="any" type="image/svg+xml">
<link href="/favicon.ico" rel="alternate icon">
<link href="/static/css/main.css" rel="stylesheet">
<meta http-equiv="onion-location" content="http://64wv2uqwjacqer7z5d6ooqgrvjwlioizmo7hgmxm7zxerbvgnoqhafid.onion/posts/2021-01-11-usbkiller.html">
<title>Usbkill the OpenBSD Way</title>
<meta property="og:title" content="Usbkill the OpenBSD Way">
<meta property="og:description" content="Using OpenBSD's hotplugd to thwart HID attacks">
</head>
<body>
<header>
<nav>
<a href="/">zakaria.org</a><a href="/posts/">posts</a><a href="/projects.html">code</a><a href="/about.html">about</a></nav>
</header>
<main>
<h1 id="%3Ccode%3Eusbkill%3C/code%3E%20the%20OpenBSD%20way"><code>usbkill</code> the OpenBSD way</h1>

<p><a href="https://github.com/hephaest0s/usbkill"><code>usbkill</code></a> is a kill-switch that shuts down your computer on any USB change. It does this by watching the output of <code>lsusb</code> and when there is a change it runs <code>shutdown -h now</code>.</p>

<p>Simple, right? One thing to note is that <code>lsusb</code> is not included in OpenBSD&#8217;s base packages, but <a href="https://man.openbsd.org/hotplugd"><code>hotplugd(8)</code></a> is.</p>

<h2 id="hotplugd">hotplugd</h2>

<p>So what is <code>hotplugd</code>, and how can it be useful? The <a href="https://man.openbsd.org/hotplugd">man page</a> does a good job of explaining it. Simply put: when any device is attached to or detached from your machine <code>hotplugd</code> will execute a script.</p>

<p>To see how simple it is to write a hotplug script we can start by simply logging device attach events. First, start by enabling and starting <code>hotplugd</code> (as root):</p>

<pre><code># rcctl enable hotplugd
# rcctl start hotplugd
hotplugd(ok)
</code></pre>

<p>Next we will write the script that is executed on a device attach event:</p>

<pre><code># mkdir -p &#47;etc&#47;hotplug
# $EDITOR &#47;etc&#47;hotplug&#47;attach
</code></pre>

<p>In this file we will log the device class and name:</p>

<pre><code>#!&#47;bin&#47;sh

DEVCLASS=$1
DEVNAME=$2

# log attach event
logger -t hotplug "$DEVCLASS:$DEVNAME attached"
</code></pre>

<p>To see this in action in another terminal type</p>

<pre><code>$ tail -f &#47;var&#47;log&#47;messages
</code></pre>

<p>Then connect a USB device to your machine and you should see messages tagged &#8216;hotplug&#8217;. This is what I get when I plug in my Logitech USB adapter for my wireless mouse (which I usually don&#8217;t use):</p>

<pre><code>Jan 11 11:48:32 x1 hotplug: 0:uhid3 attached
Jan 11 11:48:32 x1 hotplug: 5:wsmouse2 attached
Jan 11 11:48:32 x1 hotplug: 0:ums0 attached
Jan 11 11:48:32 x1 hotplug: 0:uhid1 attached
Jan 11 11:48:32 x1 hotplug: 5:wskbd1 attached
Jan 11 11:48:32 x1 hotplug: 0:uhid0 attached
Jan 11 11:48:32 x1 hotplug: 0:uhid4 attached
Jan 11 11:48:32 x1 hotplug: 0:uhid2 attached
Jan 11 11:48:32 x1 hotplug: 0:uhidev1 attached
Jan 11 11:48:32 x1 hotplug: 0:uhidev2 attached
Jan 11 11:48:32 x1 hotplug: 0:ukbd0 attached
Jan 11 11:48:32 x1 hotplug: 0:uhidev0 attached
Jan 11 11:48:32 x1 hotplug: 0:uhid5 attached
Jan 11 11:48:32 x1 hotplug: 0:uhid6 attached
</code></pre>

<p>Site note: What is happening here? Why have so many events popped up after inserting one USB device? My theory is that because it&#8217;s a <a href="https://www.logitech.com/product/unifying-receiver-usb">Unifying Receiver</a>, it allows more than one Logitech HID to be connected to a single receiver, so it must register a bunch of HIDs to the kernel.</p>

<h2 id="The%20&amp;#8216;kill&amp;#8217;%20part">The &#8216;kill&#8217; part</h2>

<p>Now that we&#8217;ve seen how <code>hotplugd</code> works, we can work on the <em>kill</em> part of <code>usbkill</code>.<br/>
We want to shutdown the machine on a device attach or detach event, but we also want to be able to arm and disarm the <em>kill</em> part, since I might need to plug something in once in a while. Make the <code>&#47;etc&#47;hotplug&#47;attach</code> script as so:</p>

<pre><code>#!&#47;bin&#47;sh

arm_file=&#47;tmp&#47;arm_usbkill

DEVCLASS="$1"
DEVNAME="$2"

logger -t "${0##*&#47;}" "${DEVCLASS}:${DEVNAME} attached"

if [ -f "$arm_file" ]; then
        shutdown -p now
else
        logger -t "${0##*&#47;}" "unarmed - aborted shutdown"
fi
</code></pre>

<p>If the <code>&#47;tmp&#47;arm_usbkill</code> file exists then the machine will shutdown, if it doesn&#8217;t exist it will just add a log entry to syslog.</p>

<p><code>hotplug</code> also supports running a different script, <code>&#47;etc&#47;hotplug&#47;detach</code> on detach events. Since both scripts are exactly the same I&#8217;ve symlinked the attach script to the location of the detach script.</p>

<pre><code># ln -s &#47;etc&#47;hotplug&#47;attach &#47;etc&#47;hotplug&#47;detach
</code></pre>

<p>The <code>${0##*&#47;}</code> logger tag gets substituted to the filename of the script being executed (in this case it is either <code>attach</code> or <code>detach</code>).</p>

<p>One thing to note is that this setup will execute the shutdown command on <em>any</em> device change event. This includes USBs but also includes network devices, disk drives, and serial line interfaces<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup>. If that is a problem, you can implement a device class-based whitelist by checking <code>$DEVCLASS</code>:</p>

<pre><code>#!&#47;bin&#47;sh

# class whitelist (space-separated)
class_whitelist="0 2 3 5"

# arm file
arm_file=&#47;tmp&#47;arm_usbkill

DEVCLASS="$1"
DEVNAME="$2"

whitelisted() {
    for class in $class_whitelist; do
        if [ "$class" = "$1" ]; then
            return 0
        fi
    done
    return 1
}

logger -t "${0##*&#47;}" "${DEVCLASS}:${DEVNAME} attached"

if [ -f "$arm_file" ]; then
    if whitelisted "$DEVCLASS"; then
        logger -t "${0##*&#47;}" "whitelisted - aborted shutdown"
        exit 0
    fi
    shutdown -p now
else
    logger -t "${0##*&#47;}" "unarmed - aborted shutdown"
fi
</code></pre>

<p>But this is not really useful to me since I use a laptop and I&#8217;m not attaching and detaching network devices or disk drives.</p>

<p>One disadvantage of this setup is the inability to whitelist devices based on their USB IDs like you can with <code>usbkill</code>. This could be acheived through a much more complicated script using <code>usbdevs</code> to get USB IDs, but as of yet I have no need for that.</p>

<h2 id="Arming%20and%20disarming">Arming and disarming</h2>

<p>To arm and disarm this script all you have to do is create or remove the <code>$arm_file</code> respectively. Here are some shell functions to add to your shell rc to make it easier:</p>

<pre><code># arm&#47;disarm usbkill
arm() {
        touch &#47;tmp&#47;arm_usbkill &#38;&#38; printf &#39;armed\\n&#39; || printf &#39;error arming\\n&#39;
}
disarm() {
        rm -f &#47;tmp&#47;arm_usbkill &#38;&#38; printf &#39;disarmed\\n&#39; || printf &#39;error disarming\\n&#39;
}
</code></pre>

<p>The script can be armed or disarmed by any regular user which may or may not be preferable to you (and isn&#8217;t the case for <code>usbkill</code>, which requires root to run).<br/>
Originally I had added the <code>uchg</code> flag to the file to lock it. But this proved to be counterproductive since it wasn&#8217;t cleared from <code>&#47;tmp</code> on reboot and when <code>hotplugd</code> would first start up, it would immediately shutdown the machine again. That was fun to fix (not).</p>

<h2 id="Why?">Why?</h2>

<p>So why do all this? Why not just <code>pkg_add usbutils</code>, download + run <code>usbkill</code> and be done?<br/>
Well for starters that isn&#8217;t as fun. The main reason is that all this works in a default OpenBSD install - no additional packages needed. Why install a program to solve a problem when the default tools and services can solve the problem just as (if not more) elegantly?</p>

<h2 id="SEE%20ALSO">SEE ALSO</h2>

<ul>
<li>OpenBSD <code>hotplug(4)</code> pseudo-device man page: <a href="https://man.openbsd.org/hotplug">https:&#47;&#47;man.openbsd.org&#47;hotplug</a> .</li>
<li>OpenBSD includes the <code>usbdevs(8)</code> tool in base that lists connected USB devices and their IDs: <a href="https://man.openbsd.org/usbdevs">https:&#47;&#47;man.openbsd.org&#47;usbdevs</a> <sup id="fnref2"><a href="#fn2" rel="footnote">2</a></sup>.</li>
<li>OpenWRT has it&#8217;s own similarly named hotplug.d service: <a href="https://openwrt.org/docs/guide-user/base-system/hotplug">https:&#47;&#47;openwrt.org&#47;docs&#47;guide-user&#47;base-system&#47;hotplug</a>. But it&#8217;s slightly different to OpenBSD&#8217;s.</li>
<li>A couple of years ago I wrote <a href="https://github.com/e-zk/hidlock">a hotplug script</a> that instead runs <a href="https://man.openbsd.org/xlock"><code>xlock(1)</code></a> on all running X displays after a HID is attached. In theory this would to thwart HID&#47;badusb attacks, while not being as aggressive as shutting down your machine. Might be worth looking into if you like the sound of that.</li>
</ul>

<div class="footnotes">
<hr/>
<ol>

<li id="fn1">
<p>As per the <a href="https://man.openbsd.org/hotplugd"><code>hotplugd(8)</code> man page</a>&#160;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

<li id="fn2">
<p>In the future I might write a script to act more similarly to <code>usbkill</code>, using <code>usbdevs</code> to poll for device changes instead of <code>lsusb</code>.&#160;<a href="#fnref2" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>
</main>
<footer>
<br><hr>
<p>posted: [&nbsp;2021-01-11&nbsp;]</p>
<p>view: [&nbsp;<a href="/posts/2021-01-11-usbkiller.md">plaintext</a>&nbsp;|&nbsp;<a href="http://64wv2uqwjacqer7z5d6ooqgrvjwlioizmo7hgmxm7zxerbvgnoqhafid.onion/posts/2021-01-11-usbkiller.html">hidden service</a>&nbsp;]</p>
<div class="qrbox">
<details class="qr"><summary>show qr: [ clear net ]</summary> <svg width="3.92cm" height="3.92cm" viewBox="0 0 37 37" preserveAspectRatio="none" version="1.1" xmlns="http://www.w3.org/2000/svg">
	<g id="QRcode">
		<rect x="0" y="0" width="37" height="37" fill="#ffffff"/>
		<path style="stroke:#000000" transform="translate(4,4.5)" d="M0,0h7M8,0h5M14,0h2M17,0h1M22,0h7M0,1h1M6,1h1M11,1h1M15,1h5M22,1h1M28,1h1M0,2h1M2,2h3M6,2h1M9,2h2M15,2h2M20,2h1M22,2h1M24,2h3M28,2h1M0,3h1M2,3h3M6,3h1M10,3h5M16,3h2M19,3h2M22,3h1M24,3h3M28,3h1M0,4h1M2,4h3M6,4h1M12,4h4M17,4h1M19,4h1M22,4h1M24,4h3M28,4h1M0,5h1M6,5h1M9,5h1M13,5h5M22,5h1M28,5h1M0,6h7M8,6h1M10,6h1M12,6h1M14,6h1M16,6h1M18,6h1M20,6h1M22,6h7M8,7h2M13,7h2M16,7h1M18,7h3M0,8h2M3,8h2M6,8h1M9,8h1M11,8h2M14,8h1M16,8h2M19,8h2M22,8h1M28,8h1M0,9h1M3,9h1M5,9h1M7,9h2M10,9h1M12,9h5M19,9h1M21,9h1M23,9h2M26,9h2M0,10h3M5,10h2M9,10h1M12,10h1M18,10h1M21,10h1M24,10h1M26,10h1M2,11h3M7,11h1M16,11h2M19,11h2M23,11h3M28,11h1M0,12h3M5,12h6M12,12h2M15,12h2M18,12h1M20,12h1M22,12h2M28,12h1M2,13h1M4,13h1M8,13h1M10,13h1M12,13h1M14,13h3M18,13h1M20,13h1M22,13h7M0,14h2M3,14h1M6,14h1M9,14h2M13,14h3M18,14h4M23,14h1M26,14h1M28,14h1M1,15h1M5,15h1M8,15h3M15,15h2M18,15h2M21,15h2M26,15h1M28,15h1M1,16h1M4,16h1M6,16h1M12,16h2M15,16h2M20,16h1M23,16h1M25,16h1M0,17h1M2,17h4M10,17h2M13,17h1M15,17h1M17,17h4M24,17h1M26,17h2M0,18h5M6,18h4M13,18h1M16,18h1M19,18h4M24,18h2M28,18h1M0,19h2M3,19h2M9,19h1M13,19h1M17,19h1M20,19h2M24,19h3M0,20h2M4,20h1M6,20h2M12,20h1M15,20h2M18,20h10M8,21h1M13,21h2M16,21h1M19,21h2M24,21h2M0,22h7M10,22h3M15,22h1M17,22h4M22,22h1M24,22h2M0,23h1M6,23h1M9,23h1M13,23h2M16,23h2M19,23h2M24,23h1M27,23h2M0,24h1M2,24h3M6,24h1M8,24h3M12,24h3M17,24h9M27,24h1M0,25h1M2,25h3M6,25h1M8,25h1M11,25h2M14,25h1M16,25h1M18,25h1M27,25h1M0,26h1M2,26h3M6,26h1M11,26h5M18,26h1M20,26h2M23,26h2M26,26h3M0,27h1M6,27h1M8,27h1M13,27h1M16,27h1M18,27h1M21,27h1M25,27h2M28,27h1M0,28h7M8,28h1M10,28h1M12,28h1M14,28h2M17,28h1M19,28h5M25,28h1"/>
	</g>
</svg> </details>
<details class="qr"><summary>show qr: [ onion url ]</summary> <!-- Created with qrencode 4.1.1 (https://fukuchi.org/works/qrencode/index.html) -->
<svg width="4.76cm" height="4.76cm" viewBox="0 0 45 45" preserveAspectRatio="none" version="1.1" xmlns="http://www.w3.org/2000/svg">
	<g id="QRcode">
		<rect x="0" y="0" width="45" height="45" fill="#ffffff"/>
		<path style="stroke:#000000" transform="translate(4,4.5)" d="M0,0h7M9,0h1M13,0h1M15,0h7M23,0h1M25,0h1M28,0h1M30,0h7M0,1h1M6,1h1M8,1h2M11,1h4M16,1h2M20,1h3M24,1h2M27,1h1M30,1h1M36,1h1M0,2h1M2,2h3M6,2h1M9,2h3M13,2h1M15,2h1M18,2h5M24,2h1M28,2h1M30,2h1M32,2h3M36,2h1M0,3h1M2,3h3M6,3h1M8,3h2M11,3h1M13,3h1M15,3h1M17,3h3M22,3h2M25,3h4M30,3h1M32,3h3M36,3h1M0,4h1M2,4h3M6,4h1M10,4h1M12,4h2M15,4h1M17,4h7M26,4h1M28,4h1M30,4h1M32,4h3M36,4h1M0,5h1M6,5h1M8,5h1M10,5h1M13,5h2M17,5h1M20,5h1M24,5h4M30,5h1M36,5h1M0,6h7M8,6h1M10,6h1M12,6h1M14,6h1M16,6h1M18,6h1M20,6h1M22,6h1M24,6h1M26,6h1M28,6h1M30,6h7M12,7h1M15,7h2M21,7h1M23,7h2M26,7h1M0,8h5M6,8h5M12,8h3M17,8h1M19,8h1M22,8h2M25,8h5M31,8h1M33,8h1M35,8h1M0,9h2M4,9h2M7,9h2M13,9h1M19,9h3M23,9h1M25,9h1M28,9h2M31,9h1M34,9h1M2,10h1M6,10h1M9,10h1M11,10h2M14,10h1M18,10h1M26,10h3M30,10h3M34,10h1M36,10h1M3,11h1M10,11h2M15,11h1M18,11h4M23,11h1M28,11h3M33,11h1M0,12h3M4,12h3M8,12h1M10,12h3M14,12h2M17,12h1M19,12h1M22,12h1M25,12h3M29,12h2M32,12h3M3,13h3M9,13h1M12,13h2M16,13h10M28,13h1M31,13h1M34,13h2M1,14h1M6,14h1M8,14h2M12,14h1M14,14h4M20,14h1M22,14h1M27,14h5M34,14h1M36,14h1M0,15h2M3,15h2M7,15h1M10,15h1M12,15h1M14,15h1M19,15h3M26,15h2M29,15h2M33,15h1M36,15h1M1,16h1M4,16h5M12,16h6M19,16h1M22,16h9M32,16h1M34,16h1M36,16h1M0,17h2M4,17h2M7,17h3M12,17h2M16,17h1M19,17h3M23,17h1M25,17h1M28,17h2M31,17h1M35,17h1M0,18h1M2,18h1M4,18h4M10,18h2M14,18h1M17,18h2M22,18h1M24,18h5M30,18h1M32,18h5M2,19h2M14,19h2M19,19h4M24,19h1M26,19h1M28,19h1M32,19h2M36,19h1M0,20h1M2,20h3M6,20h1M9,20h1M11,20h3M15,20h1M17,20h1M19,20h1M22,20h2M25,20h2M30,20h1M32,20h1M34,20h3M5,21h1M7,21h2M11,21h3M15,21h1M19,21h1M23,21h1M25,21h1M28,21h2M31,21h1M35,21h1M1,22h1M6,22h1M10,22h2M14,22h2M22,22h1M27,22h7M35,22h2M0,23h1M2,23h2M5,23h1M7,23h3M13,23h3M18,23h1M20,23h2M26,23h1M28,23h2M31,23h1M36,23h1M0,24h1M3,24h1M5,24h3M10,24h3M16,24h2M22,24h5M29,24h4M34,24h3M0,25h1M2,25h2M5,25h1M9,25h1M12,25h2M15,25h2M19,25h2M23,25h1M25,25h2M28,25h2M31,25h1M35,25h1M0,26h1M5,26h2M8,26h2M11,26h2M14,26h5M20,26h1M22,26h1M25,26h1M27,26h1M31,26h1M34,26h3M0,27h1M7,27h1M11,27h1M13,27h3M21,27h3M28,27h1M36,27h1M0,28h1M3,28h1M6,28h3M10,28h3M15,28h1M17,28h3M22,28h1M24,28h9M34,28h1M8,29h1M12,29h2M15,29h2M18,29h6M25,29h1M28,29h1M32,29h1M0,30h7M8,30h2M14,30h2M18,30h1M21,30h1M24,30h1M26,30h1M28,30h1M30,30h1M32,30h5M0,31h1M6,31h1M13,31h1M15,31h1M18,31h5M24,31h1M26,31h3M32,31h2M35,31h1M0,32h1M2,32h3M6,32h1M8,32h2M11,32h3M15,32h1M17,32h1M22,32h11M34,32h1M0,33h1M2,33h3M6,33h1M8,33h2M13,33h1M15,33h1M18,33h3M23,33h1M25,33h1M27,33h1M30,33h4M36,33h1M0,34h1M2,34h3M6,34h1M8,34h1M11,34h1M13,34h5M20,34h2M25,34h2M29,34h1M31,34h1M33,34h4M0,35h1M6,35h1M8,35h1M10,35h1M15,35h1M17,35h1M21,35h1M23,35h1M26,35h6M36,35h1M0,36h7M8,36h3M12,36h1M14,36h3M18,36h1M22,36h1M25,36h1M29,36h3M34,36h3"/>
	</g>
</svg> </details>
</div>
(C) <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>
</footer>
</body>
</html>
