<rss version="2.0" xml:base="https://zakaria.org">
<channel>
<title>zakaria's web log</title>
<description/>
<link>https://zakaria.org/posts/</link>
<item>
<link>https://zakaria.org/posts/headscale-setup.html</link>
<title>Installing Headscale on OpenBSD</title>
<pubDate>Tue, 15 Feb 2022 00:00:00 +0000</pubDate>
<description>
<h1 id="Installing%20headscale%20on%20OpenBSD">Installing headscale on OpenBSD</h1>

<p>In this post I&#39;ll detail the steps I took to install and configure
<a href="https://github.com/juanfont/headscale">headscale</a>, an open-source self-hostable implementation of the <a href="https://tailscale.com/">Tailscale</a> control server, on OpenBSD.</p>

<p>Code blocks prefixed with <code>#</code> imply that the command should be run as a privileged user&#47;root.</p>

<p>If you get stuck, it&#39;ll be probably worthwhile to have a read of headscale&#39;s documentation available in their GitHub repo: <a href="https://github.com/juanfont/headscale/tree/main/docs">https:&#47;&#47;github.com&#47;juanfont&#47;headscale&#47;tree&#47;main&#47;docs</a> .</p>

<h2 id="Compilation">Compilation</h2>

<p>Since my server is on OpenBSD-stable, headscale is only available via <code>pkg_add</code> on -current, I need to compile the headscale binary by hand and upload it to the server.
I&#39;m doing this on an OpenBSD machine, so compiling and uploading it to the server
should be a breeze.</p>

<pre><code>$ git clone git@github.com:juanfont&#47;headscale.git
$ cd headscale
$ make generate
$ make build
$ sftp user@server &#60;&#60;EOF
&#62; put .&#47;headscale
&#62; bye
EOF
</code></pre>

<p>Then login, get root access, and copy the binary to <code>&#47;usr&#47;local&#47;bin</code>:</p>

<pre><code>$ ssh user@server
$ doas -s
...
# cp .&#47;headscale &#47;usr&#47;local&#47;bin
# chown root:bin &#47;usr&#47;local&#47;bin&#47;headscale
</code></pre>

<h2 id="Configuration">Configuration</h2>

<p>Next we need to setup:</p>

<ol start="1">
<li>a <code>_headscale</code> daemon user that headscale will run as.</li>
<li>directories for headscale to store its sqlite database, private key, and socket (making sure they have the correct permissions&#47;owner).</li>
<li>copy the example config from GitHub, and edit it to our liking</li>
</ol>

<p>First we setup some directories:</p>

<pre><code># mkdir -p &#47;etc&#47;headscale
# touch &#47;etc&#47;headscale&#47;config.yaml
# mkdir -p &#47;var&#47;headscale
</code></pre>

<p>Then we add our <code>_headscale</code> daemon user, and <code>chown</code> all the necessary dirs.<br/>
Here we also run <code>doas</code> to get us a shell as <code>_headscale</code> so I can create the db.sqlite file. Note doing it this way requires some <code>doas.conf</code> rules.</p>

<pre><code># useradd -L daemon -s &#47;sbin&#47;nologin -d &#47;var&#47;headscale _headscale
# chown -R _headscale:_headscale &#47;var&#47;headscale 
# doas -u _headscale &#47;bin&#47;ksh
$ touch &#47;var&#47;headscale&#47;db.sqlite
</code></pre>

<p>Finally we can edit the headscale config. I highly recommend copying the <a href="https://raw.githubusercontent.com/juanfont/headscale/main/config-example.yaml">example config</a> and using that as a starting point.</p>

<pre><code># vi &#47;etc&#47;headscale&#47;config.yaml
# # copy the example config
# # change domain, IPs, ports
# # change sock location to &#47;var&#47;headscale&#47;headscale.sock 
</code></pre>

<p>I&#39;m currently using <a href="https://man.openbsd.org/relayd">relayd(8)</a> as a TLS proxy, so I don&#39;t need to
configure any TLS-related stuff.</p>

<p>Run <code>headscale serve</code> to see if the config works, and all the directories and permissions are correct:</p>

<pre><code># doas -u _headscale headscale serve
...
</code></pre>

<p>If all is well we can move onto setting up an init script for the headscale daemon.</p>

<h2 id="rc.d">rc.d</h2>

<p>I&#39;ve made an init script to making stopping&#47;starting and running at boot
a lot easier. Drop this simple script into <code>&#47;etc&#47;rc.d&#47;headscale</code>:</p>

<pre><code>#!&#47;bin&#47;ksh
#
# &#47;etc&#47;rc.d&#47;headscale

daemon_user="_headscale"
daemon="&#47;usr&#47;local&#47;bin&#47;headscale"
daemon_flags="serve"

. &#47;etc&#47;rc.d&#47;rc.subr

rc_cmd $1
</code></pre>

<p><code>chmod</code>, enable and start it as usual:</p>

<pre><code># chmod +x &#47;etc&#47;rc.d&#47;headscale
# rcctl enable headscale
# rcctl start headscale
headscale(ok)
</code></pre>

<h2 id="Clients">Clients</h2>

<p>So here&#39;s where you may run into some problems. Depending on the OS your client is going to be running on, it might be a little difficult to get Tailscale to use your custom control server. On Android, this editing the hardcoded Tailscale control server URL, and compiling the client from source.</p>

<h3 id="OpenBSD%20client">OpenBSD client</h3>

<p>It&#39;s pretty easy to get the Tailscale client on OpenBSD to use your control server. </p>

<pre><code># pkg_add tailscale
# rcctl enable tailscaled; rcctl start tailscaled
# tailscale --login-server "https:&#47;&#47;headscale.example.com:443"
...
</code></pre>

<p>Where <code>https:&#47;&#47;headscale.example.com:443</code> is your control server URL.</p>

<h3 id="Android%20client">Android client</h3>

<p>You can find the instructions for patching and building the custom APK <a href="https://github.com/juanfont/headscale/issues/58#issuecomment-950386833">here</a>.</p>

<p>I didn&#39;t bother even attempting to install the android sdk, ndk, and all the other required (garbage) on OpenBSD to compile the Android client. So I booted into Windows, then logged into Ubuntu on WSL, then had to install Go manually (since Ubuntu 20.04 packages are old AF and I can&#39;t be bothered to move all the junk I&#39;ve accumulated in my WSL distro&#39;s $HOME). Then i installed the sdkmanager manually, then i installed the ndk through that manually, then I ran <code>make tailscale-debug.apk</code>.</p>

<p>Quite frankly this was painful, but it isn&#39;t supposed to be. Wrangling with old documentation I found online about installing the android sdk on the outdated WSL Ubuntu setup I have set me back a few hours.</p>

<p>In the end it was quite rewarding to install the APK file, open it up and see it all working!</p>
</description>
</item>
<item>
<link>https://zakaria.org/posts/stagit-setup.html</link>
<title>My stagit setup</title>
<pubDate>Mon, 14 Feb 2022 00:00:00 +0000</pubDate>
<description>
<h1 id="stagit%20setup%20on%20OpenBSD">stagit setup on OpenBSD</h1>

<p><a href="https://codemadness.org/stagit.html">stagit</a> is a static page generator for git repos. It&#39;s very minimal - which I like.</p>

<p>In this post I&#39;ll detail how I set up <a href="https://git.zakaria.org/">git.zakaria.org</a> on my OpenBSD server.</p>

<p>The majority of my setup is based upon a post by <code>poptart</code>. Be sure to check out the original post here: <a href="https://hosakacorp.net/p/stagit-server.html">https:&#47;&#47;hosakacorp.net&#47;p&#47;stagit-server.html</a>. It&#39;s pretty well done, and easy to follow (unlike my post here - which is really more for my sake when I inevitably bork my server again and have to re-do it all). <code>poptart</code> has some other great OpenBSD-related posts on there as well.</p>

<h2 id="Setup">Setup</h2>

<p>On the server install <code>git</code>, create the <code>_git</code> user, and make some directories:</p>

<pre><code>server# pkg_add git libgit2
server# groupadd _git
server# mkdir -p -m 744 &#47;var&#47;git&#47;repos &#47;var&#47;git&#47;template
server# useradd -g _git -L daemon -c "git backend user" -d &#47;var&#47;git&#47;repos -s &#47;usr&#47;local&#47;bin&#47;git-shell _git
server# chown _git:_git &#47;var&#47;git&#47;repos
</code></pre>

<p>The directories we created:</p>

<ul>
<li><code>&#47;var&#47;www&#47;repos</code> contains the bare git files (also the <code>$HOME</code> of user <code>_git</code>)</li>
<li><code>&#47;var&#47;git&#47;template</code> will contain the template for new repositories.</li>
</ul>

<p>The next steps are only if like me you&#39;ve made source changes to stagit and you&#39;d like to use your custom version. If you want to use plain stagit, install it on the server with <code>pkg_add stagit</code>.<br/>
On another machine, compile stagit and <code>sftp</code> it over to the server:</p>

<pre><code>laptop$ make
laptop$ md5 stagit stagit-index
laptop$ # remember these checksums for verifying it&#39;s been copied over correctly
laptop$ sftp enderman &#60;&#60;EOF
&#62; put stagit
&#62; put stagit-index
&#62; bye
EOF
</code></pre>

<p>Back on the server, verify the binaries were copied over correctly:</p>

<pre><code>server# md5 stagit stagit-index
server# # verify the checksums
</code></pre>

<p>Copy these binaries to <code>&#47;usr&#47;local&#47;bin</code> and set permissions appropriately:</p>

<pre><code>server# cp stagit{,-index} &#47;usr&#47;local&#47;bin
server# chown root:bin &#47;usr&#47;local&#47;bin&#47;stagit{,-index} 
server# chmod 755 &#47;usr&#47;local&#47;bin&#47;stagit{,-index}
</code></pre>

<p>The following is a message from the future:</p>

<blockquote>
<p>I wrote this post a while ago. But I recall abandoning the modified stagit binary setup
purely because the libraries on my laptop were newer than my server, and I 
could not get static compilation to work&#8230; 
So I gave up and installed stagit via <code>pkg_add stagit</code> on the server :P</p>
</blockquote>

<h2 id="Scripts">Scripts</h2>

<p>Next we&#39;ll configure a few scripts:</p>

<ul>
<li><code>&#47;var&#47;git&#47;repos&#47;template&#47;post-receive</code><br/>
Will be executed every time we push to a repo.</li>
<li><code>&#47;usr&#47;local&#47;bin&#47;stagit-gen-index</code><br/>
A helper script to generate the index page.</li>
<li><code>&#47;usr&#47;local&#47;bin&#47;stagit-newrepo</code><br/>
Script to run to create a new repository.</li>
<li><code>&#47;usr&#47;local&#47;bin&#47;stagit-chdesc</code><br/>
Script to change the description of an existing repository.</li>
</ul>

<p>Some internal variables will be shared between these scripts, for instance the
git user, htdocs path, etc. Instead of writing these out into each script we
can create a config file that each script will source before running anything.<br/>
In <code>&#47;var&#47;git&#47;config.rc</code>:</p>

<pre><code># shared variables
GIT_HOME="&#47;var&#47;git"
GIT_REPOS="${GIT_HOME}&#47;repos"
WWW_HOME="&#47;var&#47;www&#47;htdocs&#47;git.zakaria.org
CLONE_URI="_git@git.zakaria.org"
DEFAULT_OWNER="zakaria"
DEFAULT_DESC=""
GIT_USER="_git"
</code></pre>

<p>We restrict access to this file to <code>root:wheel</code>:</p>

<pre><code>server# chown root:wheel &#47;var&#47;git&#47;config.rc
</code></pre>

<p>After a <code>git push</code> we want the server to (re)generate the static html pages. To do this, we write a script in <code>&#47;var&#47;git&#47;template&#47;post-receive</code>:</p>

<pre><code>#!&#47;bin&#47;sh
# Author: Cale "poptart" Black
# Modified by: zakaria @ zakaria.org
# License: MIT

set -euf

. &#47;var&#47;git&#47;config.rc

export LC_TYPE="en_US.UTF-8"
src="$(pwd)"
name="$(basename "$src")"
dest="${WWW_HOME}&#47;$(basename "$name" &#39;.git&#39;)"
mkdir -p "$dest"
cd "$dest" || exit 1

echo "[stagit] building $dest"
&#47;usr&#47;local&#47;bin&#47;stagit "$src"

echo "[stagit] linking $dest"
# if a README.html exists use that as the index.html
# if not use log.html
if [ -f "README.html" ]; then
    ln -sf README.html index.html
else
    ln -sf log.html index.html
fi
ln -sf ..&#47;style.css style.css
ln -sf ..&#47;logo.png logo.png
</code></pre>

<p>Next, we need a script to generate the stagit <code>&#47;index.html</code>. In <code>&#47;usr&#47;local&#47;bin&#47;stagit-gen-index</code>:</p>

<pre><code>#!&#47;bin&#47;sh 
# Author: Cale "poptart" Black
# License: MIT

set -eu

. &#47;var&#47;git&#47;config.rc
stagit-index "${GIT_REPOS}&#47;*.git" &#62; "${WWW_HOME}&#47;index.html"
</code></pre>

<p>The next script will be used to setup a new repository. In <code>&#47;usr&#47;local&#47;bin&#47;stagit-newrepo</code>:</p>

<pre><code>#!&#47;bin&#47;sh
# Author: Cale "poptart" Black
# Modified by: zakaria @ zakaria.org
# License: MIT
# Usage: stagit-newrepo &#60;name&#62; [desc] [author]

set -eu

. &#47;var&#47;git&#47;config.rc

log() {
    printf &#39;%s\n&#39; "$*" &#62;&#38;2
}
die() {
    log "error: $*"
    printf &#39;exiting...\n&#39;
    exit 1
}

REPO="$1"
DESC="${2:-$DEFAULT_DESC}"
OWNER="${3:-$DEFAULT_OWNER}"

if [ -z "$REPO" ]; then
    die "no repo name given"
fi

REPO_PATH="${GIT_REPOS}&#47;${REPO}.git"

git init --bare "$REPO_PATH"
cp "${GIT_HOME}&#47;template&#47;post-receive" "${REPO_PATH}&#47;hooks&#47;post-receive"
echo "${CLONE_URI}&#47;${REPO}.git" &#62; "${REPO_PATH}&#47;url"
echo "$OWNER" &#62; "${REPO_PATH}&#47;owner"
echo "$DESC" &#62; "${REPO_PATH}&#47;description"

chmod u+x "${REPO_PATH}&#47;hooks&#47;post-receive"
mkdir "${WWW_HOME}&#47;${REPO}"
&#47;usr&#47;local&#47;bin&#47;stagit-gen-index
</code></pre>

<p>At the end of this script we call our <code>stagit-gen-index</code> helper script to regenerate
the <code>index.html</code>.</p>

<p>The last script is a simple wrapper that will allow us to change a repo&#39;s description:</p>

<pre><code>#!&#47;bin&#47;sh
# Author: zakaria &#47; zakaria.org
# License: MIT
# Usage: stagit-chdesc &#60;repo&#62; &#60;new_description&#62;

set -eu

. &#47;var&#47;git&#47;config.rc

log() {
    printf &#39;%s\n&#39; "$*" &#62;&#38;2
}
die() {
    log "error: $*"
    printf &#39;exiting...\n&#39;
    exit 1
}

REPO="$1"
DESC="$2"

if [ -z "$REPO" ]; then
    die "no repo name provided"
fi
if [ -z "$DESC" ]; then
    die "no new description provided"
fi

REPO_PATH="${GIT_REPOS}&#47;${REPO}.git"

echo "$DESC" &#62; ${REPO_PATH}&#47;description
</code></pre>

<p>Then set the appropriate permissions and restrictions for these scripts:</p>

<pre><code>$ chmod +x &#47;usr&#47;local&#47;bin&#47;stagit-{gen-index,newrepo,chdesc}
$ chown -R _git:_git &#47;var&#47;git&#47;template
$ chmod +x $GIT_HOME&#47;template
$ chown -R _git:_git $WWW_HOME
</code></pre>

<p>Replacing <code>GIT_HOME</code> and <code>WWW_HOME</code> with the variables we configured previously in <code>config.rc</code>.</p>

<p>Finally we configure our <a href="https://man.openbsd.org/doas.conf">doas.conf(5)</a> to allow our main user to run these commands:</p>

<pre><code>permit nopass mite as _git cmd &#47;usr&#47;local&#47;bin&#47;stagit-newrepo
permit nopass mite as _git cmd &#47;usr&#47;local&#47;bin&#47;stagit-gen-index
permit nopass mite as _git cmd &#47;usr&#47;local&#47;bin&#47;stagit-chdesc
</code></pre>

<p>I&#39;ve made a git repository for these scripts (and maybe a few more) available on <a href="https://github.com/e-zk/stagit-scripts">GitHub</a> which is mirrored on <a href="https://git.zakaria.org/stagit-scripts/log.html">git.zakaria.org</a></p>

<h2 id="httpd%20config">httpd config</h2>

<p>To actually serve the generated static files we need to configure <a href="https://man.openbsd.org/httpd">httpd(8)</a>. In <a href="https://man.openbsd.org/httpd.conf"><code>&#47;etc&#47;httpd.conf</code></a>:</p>

<pre><code>...snip...

server "git.zakaria.org" {
    listen on 127.0.0.1 on 8080

    # for letsencrypt
    location "&#47;.well-known&#47;acme-challenge&#47;*" {
        root "&#47;acme"
        request strip 2
    }

    root "&#47;htdocs&#47;git.zakaria.org"
}

...snip...
</code></pre>

<p>I use <a href="https://man.openbsd.org/relayd">relayd(8)</a> as a TLS proxy, so I don&#39;t need to configure TLS certs in httpd.conf.</p>
</description>
</item>
<item>
<link>https://zakaria.org/posts/temporarybrowsing.html</link>
<title>Temporary web browsing</title>
<pubDate>Mon, 13 Dec 2021 00:00:00 +0000</pubDate>
<description>
<h1 id="Temporary%20web%20browsing">Temporary web browsing</h1>

<p>Here&#39;s a few ways of scripting an ephemeral browser environment.</p>

<p>The idea is that the entire state of the browser is ephemeral - on exit
everything should be removed from storage including cookies, history
bookmarks, etc. This is more aggressive than your standard incognito mode
as it directly removes all files associated with the browser instance.</p>

<p>I use this all the time because for some things I don&#39;t find it necessary
for history, bookmarks, etc to be saved (a quick web search, logging into 
personal, sensitive services like online banking). Some might find it 
over-the-top but I think its a useful scripting exercise if anything.</p>

<h2 id="1.%20Temporary%20profile">1. Temporary profile</h2>

<p>Browsers typically have a user &#8220;profile&#8221;, where all bookmarks, history, and
other required state is stored.<br/>
Most browsers that matter (Firefox, Chromium) allow the directory this profile
information is stored in to be configured via a CLI flag. For firefox this is 
<code>---profile &#60;path&#62;</code>, which defaults to somewhere in <code>~&#47;.local</code> if my memory 
serves correct. Similarly, Chromium (and I assume other Chromium-based browsers
by proxy) support this via the <code>--user-data-dir=&#60;path&#62;</code>, which defaults to 
<code>~&#47;.config&#47;chromium</code>.</p>

<p>This feature can be used to create a fresh, new profile in a custom directory.
On exit this directory can be aggressively removed by a simple <code>rm -rf &#60;path&#62;</code>
command. Here&#39;s a short script to facilitate all this for Firefox:</p>

<pre><code>#!&#47;bin&#47;sh

# make temporary profile directory
PROFILE_DIR="$(mktemp -d -p &#47;tmp &#39;firefox.XXXXXX&#39;)"

cleanup() {
    rm -rvf "$PROFILE_DIR"
}

firefox-esr --new-instance --no-remote --profile "$PROFILE_DIR" "$@"

cleanup
</code></pre>

<p>First the script creates a temporary directory via <code>mktemp</code>, where the profile
will be. Next we define a cleanup function to be run after Firefox, so that on
exit the profile is simply <code>rm -rf</code>&#39;d. Then <code>firefox-esr</code> is run (replace this
with <code>firefox</code> if you don&#39;t use the ESR variant), and the profile directory is 
specified with <code>--profile</code>.</p>

<p>I also included the <code>--new-instance</code> flag to make sure Firefox didn&#39;t just
open a tab in an already running instance, and <code>--no-remote</code> to dissallow 
remote commands. </p>

<p>Additional arguments can be passed to the script - these will be directly added to
<code>firefox-esr</code>&#39;s arguments.</p>

<p>I also like to add a <code>trap</code> to the script, so if it ever exits unexpectedly,
the clean-up process will still take place. This is what that looks like:</p>

<pre><code>#!&#47;bin&#47;sh
# trap everything; clean up on exit
trap cleanup 1 2 3 6 15

# make temporary profile directory
PROFILE_DIR="$(mktemp -d -p &#47;tmp &#39;firefox.XXXXXX&#39;)"

cleanup() {
    rm -rvf "$PROFILE_DIR"
}

firefox-esr --new-instance --no-remote --profile "$PROFILE_DIR" "$@"

cleanup
</code></pre>

<p>The equivalent final script for Chromium&#47;Chrome:</p>

<pre><code>#!&#47;bin&#47;sh
# trap everything; clean up on exit
trap cleanup 1 2 3 6 15

# make temporary profile directory
PROFILE_DIR="$(mktemp -d -p &#47;tmp &#39;chrome.XXXXXX&#39;)"

cleanup() {
    rm -rvf "$PROFILE_DIR"
}

chromium --user-data-dir="$PROFILE_DIR" "$@"

cleanup
</code></pre>

<h2 id="2.%20Temporary%20home%20directory">2. Temporary home directory</h2>

<p>Instead of specifying a custom profile, then removing it, why not create an
entire ephemeral home directory, then remove <em>that</em>?</p>

<p>This trick is fairly simple and works on <em>any program</em>, not just browsers.
Just re-define the <code>$HOME</code> environment variable to <code>$FAKEHOME</code>, and any program that runs 
after that will &#8220;think&#8221; that&#39;s the real home directory:</p>

<pre><code>$ FAKEHOME=&#47;tmp&#47;firefox
$ HOME=$FAKEHOME firefox [...] https:&#47;&#47;zakaria.org&#47;
</code></pre>

<p>Note this method means removing <code>$FAKEHOME&#47;Downloads</code> and <em>any</em> directory the 
program creates in its dedicated home directory on exit. If you&#39;ve downloaded
something you&#39;d like to keep you&#39;ll need to copy it out of <code>$FAKEHOME&#47;Downloads</code> 
<em>BEFORE</em> closing the browser.<br/>
Since the program runs in a new home directory, if you use X11 it won&#39;t have 
access to <code>~&#47;.Xauthority</code>, so it won&#39;t be able to actually be graphically useful. 
To fix this simply symlink <code>~&#47;.Xauthority</code> to <code>$FAKEHOME&#47;.Xauthority</code> before running.</p>

<p>A script that does all this, plus some more:</p>

<pre><code>#!&#47;bin&#47;sh
# trap everything; clean up on exit
trap cleanup 1 2 3 6 15

# setup fake home dir
FAKEHOME="$(mktemp -d -p &#47;tmp &#39;firefox.XXXXXX&#39;)"

# clean up after exit
cleanup() {
    rm -rvf "$FAKEHOME"
}

# link Xauthority
ln -s "${HOME}&#47;.Xauthority" "${FAKEHOME}&#47;.Xauthority"

# unset XDG dirs as these can intefere with the fake $HOME if they&#39;re set
# to something non-default
unset XDG_CONFIG_HOME
unset XDG_CACHE_HOME

# set the fake home dir
export HOME=${FAKEHOME}

# run firefox w&#47; given args
firefox-esr --new-instance --no-remote "$@"

# uncomment for chrome
# chromium "$@"

cleanup
</code></pre>

<h2 id="Extra%20stuff">Extra stuff</h2>

<p>To add to these scripts, one could also:</p>

<ul>
<li>Force a specific user-agent string</li>
<li>Configure <code>user.js</code> used by Firefox by writing to <code>$PROFILE_DIR&#47;user.js</code>
before actually running the Firefox command</li>
</ul>

<p>My personal scripts do just that, for <a href="https://git.zakaria.org/bin-obsd/file/tmpchrome.html">Chromium</a> and <a href="https://git.zakaria.org/bin-obsd/file/tmpfox.html" title="maybe uses outdated user.js flags">Firefox</a>. </p>

<h2 id="Other%20methods">Other methods</h2>

<p>Some other methods to look into include:</p>

<ul>
<li>Mounting a new <strong>in-memory filesystem</strong> dedicated to a fake home dir or browser 
profile

<ul>
<li>OpenBSD does not support mounting filesystems as non-root
users, so this isn&#39;t ideal for my setup.</li>
</ul></li>
<li>Ephemeral <strong>containers</strong>

<ul>
<li>While the security aspects of Linux containers are overrated IMO, using
one as the basis for an ephemeral browser instance doesn&#39;t sound like an awful
idea.</li>
</ul></li>
<li>Dedicated <strong>virtual machine</strong>

<ul>
<li>I&#39;ve actually accomplished this in the past on an Alpine Linux VM running on OpenBSD&#39;s 
<a href="https://man.openbsd.org/vmd">vmd(8)</a> and X11 forwarding. But I never fleshed out
any scripts for making it truly ephemeral - that might be the focus of a future blog post. 
<a href="/static/img/linuxwebvm.png">Here&#39;s</a> an old screenshot of that running on OpenBSD 6.7. </li>
</ul></li>
</ul>
</description>
</item>
<item>
<link>https://zakaria.org/posts/breaking_promises.html</link>
<title>Breaking promises with LD_PRELOAD</title>
<pubDate>Tue, 07 Dec 2021 00:00:00 +0000</pubDate>
<description>
<h1 id="Breaking%20promises%20with%20LD_PRELOAD">Breaking promises with LD_PRELOAD</h1>

<p>In this post I show how to simply <a href="https://wikipedia.org/wiki/NOP_(code)">noop</a> calls to OpenBSD&#39;s <a href="https://man.openbsd.org/pledge">pledge(1)</a> using LD_PRELOAD.</p>

<p>I only focus on pledge(2), only because that&#39;s what I first tried this out on.
But this will also work for <a href="https://man.openbsd.org/unveil">unveil(2)</a>, and any syscall you want for that matter.</p>

<p>Before we get into it, this doesn&#39;t actually make pledge(2) completely useless, nor is it an oversight by the developers of OpenBSD - LD_PRELOAD can be used to break any and every system call. I just thought it was a neat trick that might be useful for CTFs or something. In regard to the title, I just couldn&#39;t pass on the fantastic opportunity for some word play+clickbait.</p>

<h2 id="Crafting%20a%20shared%20object">Crafting a shared object</h2>

<p>LD_PRELOAD works by loading a shared object file that can essentially re-define whatever C function or syscall you like before running the actual program.</p>

<p>To craft our shared object to use with LD_PRELOAD first we have to look up the function signature of pledge(2) in the <a href="https://man.openbsd.org/pledge">man page</a> and plop it into a .c file:</p>

<pre><code class="language-c">#include &#60;unistd.h&#62;

int
pledge(const char *promises, const char *execpromises)

</code></pre>

<p>Next, we want to make sure when called pledge(2) does absolutely nothing and returns success every time it&#39;s called. Alternatively, you could add additional <a href="https://man.openbsd.org/pledge">promises</a>, or remove specific promises, but I think its more jarring to make it do absolutely nothing.</p>

<pre><code class="language-c">&#47;&#47; pledge_override.c
#include &#60;unistd.h&#62; 

int 
pledge(const char *promises, const char *execpromises) {
    &#47;&#47; noop
    return 0;
}
</code></pre>

<p>Compile it into a shared object <code>override.so</code>:</p>

<pre><code class="language-console">$ cc -shared -fPIC -o override.so pledge_override.c
</code></pre>

<p>Now, with this shared object file, you can run anything you want ignoring it&#39;s pledge(2) promises:</p>

<pre><code class="language-console">$ LD_PRELOAD=$PWD&#47;override.so &#60;program&#62;
</code></pre>

<h2 id="Testing%20it%20out">Testing it out</h2>

<p>Here we have an example use of pledge(2) (yes, I should be checking return values).</p>

<pre><code class="language-c">&#47;&#47; test.c
#include &#60;stdio.h&#62;
#include &#60;unistd.h&#62;

int
main(void) {
    &#47;&#47; promise to only use stdio
    pledge("stdio", NULL);
    printf("Hello! I will abort now :3\n");

    &#47;&#47; revoke all promises
    pledge("", NULL);

    &#47;&#47; should abort here
    printf("You should not be seeing this :O\n");
    return 0;
}
</code></pre>

<p>When run normally the program should abort at the second call to printf(3) since after the
first one we&#39;ve revoked the privilege to call <code>stdio</code> functions.</p>

<pre><code class="language-console">$ .&#47;a.out
Hello! I will abort now :3
Abort trap (core dumped)
</code></pre>

<p>Then, when we add our specially crafted <code>override.so</code> to the equation:</p>

<pre><code class="language-console">$ LD_PRELOAD=$PWD&#47;override.so .&#47;a.out
Hello! I will abort now :3
You should not be seeing this :O
</code></pre>

<h2 id="When%20this%20won&amp;#39;t%20work">When this won&#39;t work</h2>

<p>Using LD_PRELOAD like this to get around pledge doesn&#39;t work when:</p>

<ol start="1">
<li>You statically link your binary

<ul>
<li>If you statically link your binary, LD_PRELOAD does not have any effect.</li>
<li>To test this out, compile the above example program with <code>-static</code>, then try and do the LD_PRELOAD trick again. It&#39;ll always abort at the correct printf(3) call.</li>
</ul></li>
<li>SUID &#47; SGID

<ul>
<li>SUID or SGID binaries aren&#39;t affected by LD_PRELOAD according to the OpenBSD <a href="https://man.openbsd.org/ld.so#LD_PRELOAD">man page</a>.<br/>
The Linux <a href="https://linux.die.net/man/8/ld.so">man page</a> is less clear about this, but I assume its the same.</li>
<li>Simply put, your doas(1) and sudo(1) are safe.</li>
</ul></li>
</ol>
</description>
</item>
<item>
<link>https://zakaria.org/posts/winsandbox.html</link>
<title>Windows Sandbox</title>
<pubDate>Sun, 08 Aug 2021 00:00:00 +0000</pubDate>
<description>
<h1 id="Windows%20Sandbox">Windows Sandbox</h1>

<p>If you[&#8216;re forced to] use Windows this might be useful for compartmentalisation.  </p>

<p>Windows Sandbox is a Windows 10 Pro feature that enables the use of temporary Virtual Machines. These can be used as ephemeral sandboxes for applications.</p>

<h2 id="Enabling">Enabling</h2>

<p>Windows Sandbox isn&#39;t enabled by default. To enable it follow these steps:</p>

<ol start="1">
<li>Open &#8220;Control Panel&#8221; and click the upside down caret next to the back&#47;forward buttons</li>
<li>Click &#8220;All Control Panel Items&#8221;</li>
<li>Navigate to &#8220;Programs and Features&#8221;</li>
<li>On the left click &#8220;Turn Windows features on or off&#8221;</li>
<li>Scroll down and tick the box next to &#8220;Windows Sandbox&#8221; if it isn&#39;t already ticked</li>
</ol>

<p>From the start menu search for &#8220;Windows Sandbox&#8221;. Hit enter and a fresh Sandbox window will appear.</p>

<h2 id="Configuring">Configuring</h2>

<p>Once the sandbox window is closed all data is erased. Next time you open Windows Sandbox a fresh new VM is created.<br/>
This can make it annoying if you wish to sandbox a single program, but have to install it every time you start a new sandbox.</p>

<p>To make it easier for these cases you can pre-configure sandbox instances via <code>.wsb</code> files. With this file you can configure memory, networking, audio&#47;video passthrough, among other things. See the Microsoft official documentation for Windows Sandbox configuration<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup>. It also supports running a script at startup, and mapping network devices and local shares.</p>

<p>I highly suggest reading through the documentation for the <code>.wsb</code> file format. There are some good examples and interesting features.</p>

<h3 id="Example:%20Zoom">Example: Zoom</h3>

<p>Zoom is a very popular group call&#47;video conference software (I won&#39;t bore you with the details I&#39;m sure you have <em>some</em> idea what Zoom is by now). However, Zoom has had numerous security and privacy issues. If you&#39;re paranoid like me you may feel uneasy just seeing it&#39;s icon in the start menu - knowing you have it installed on the same machine along with all your other precious digital data. I digress, here is a configuration file for my Zoom sandbox:</p>

<pre><code class="language-xml">&#60;Configuration&#62;
    &#60;MappedFolders&#62;
        &#60;MappedFolder&#62;
            &#60;HostFolder&#62;C:\Sandbox\Installers&#60;&#47;HostFolder&#62;
            &#60;SandboxFolder&#62;C:\Installers&#60;&#47;SandboxFolder&#62;
            &#60;ReadOnly&#62;true&#60;&#47;ReadOnly&#62;
        &#60;&#47;MappedFolder&#62;
    &#60;&#47;MappedFolders&#62;
    &#60;AudioInput&#62;Enable&#60;&#47;AudioInput&#62;
    &#60;VideoInput&#62;Enable&#60;&#47;VideoInput&#62;
    &#60;VGpu&#62;Enable&#60;&#47;VGpu&#62;
    &#60;MemoryInMB&#62;12288&#60;&#47;MemoryInMB&#62;
    &#60;LogonCommand&#62;
        &#60;Command&#62;C:\Installers\ZoomInstaller.exe&#60;&#47;Command&#62;
    &#60;&#47;LogonCommand&#62;
&#60;&#47;Configuration&#62;
</code></pre>

<p>It maps the local <code>C:\Sandbox\Installers</code> directory (where I store <code>ZoomInstaller.exe</code>) to <code>C:\Installers</code> in the VM itself. Enables audio (mic) and video (webcam) passthrough. I allocate 12Gb to the VM - should be more than enough on my laptop with 16Gb of RAM. It then runs the Zoom installer on startup.</p>

<p>The verdict? It works fairly well. Recently however webcam passthrough has stopped working, possibly due to a driver issue. (Installing drivers requires the machine to reboot - but you can&#39;t reboot a sandbox without deleting everything).</p>

<p>I make use of a couple of these <code>.wsb</code> files for different programs I&#39;d rather install on an ephemeral virtual machine than my main OS.</p>

<div class="footnotes">
<hr/>
<ol>

<li id="fn1">
<p><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-sandbox/windows-sandbox-configure-using-wsb-file">https:&#47;&#47;docs.microsoft.com&#47;en-us&#47;windows&#47;security&#47;threat-protection&#47;windows-sandbox&#47;windows-sandbox-configure-using-wsb-file</a>&#160;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>
</description>
</item>
<item>
<link>https://zakaria.org/posts/2021-02-24-feb.html</link>
<title>Feb 2021 Update: Git Server + Hidden Service</title>
<pubDate>Wed, 24 Feb 2021 00:00:00 +0000</pubDate>
<description>
<h1 id="Update%20Feb%202021:%20git%20server%20+%20hidden%20service">Update Feb 2021: git server + hidden service</h1>

<p>Here&#39;s a little site update.</p>

<h2 id="CSS%20changes">CSS changes</h2>

<p>As usual the CSS of this website is ever-changing. I&#39;ve changed it to be more monochrome, with blue highlights on link hover&#47;focus and text selection. Headings are now all <code>1em</code>.</p>

<h2 id="Git%20server">Git server</h2>

<p>I&#39;ve set up a git server on <a href="https://git.zakaria.org/">git.zakaria.org</a> using <a href="https://codemadness.org/stagit.html">stagit</a> to generate the pages. I followed a guide by <code>poptart</code><sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup>. It&#39;s a very well written guide for setting up stagit on OpenBSD.<br/>
I modified some of the scripts provided to suit my workflow.</p>

<p>I plan to move most of my projects that don&#39;t require an issue tracker over there. Namely personal configs&#47;programs.</p>

<h2 id="Hidden%20service">Hidden service</h2>

<p>During January I made this site accessible over Tor via a <a href="https://wikipedia.org/wiki/Tor_(anonymity_network)#Onion_services">hidden service&#47;onion service</a>. I had some (layer 8) issues with the service provider and had to reset the server and so the service URL has changed a few times. The canonical onion service URL can be found on the <a href="/about.html">about page</a> or in the footer.</p>

<p>Why have I setup an onion service? Three reasons:</p>

<ol start="1">
<li>Tor is a technology that interests me</li>
<li>I wanted to see how difficult it would be to setup a hidden service (it was not difficult<sup id="fnref2"><a href="#fn2" rel="footnote">2</a></sup>)</li>
<li>It&#39;s fun</li>
</ol>

<p>Because onion services can&#39;t have subdomains, I&#39;ve setup <code>relayd(8)</code> so the git server can be accessed on the service via a <code>&#47;git&#47;</code> endpoint (this is only available on the hidden service).</p>

<h2 id="Other">Other</h2>

<p>Edit 20201-02-25: Apologies for those who now have duplicate RSS entries. I&#39;ve redone the RSS script, so the new feed might have merged with the old in your readers. Removing and re-adding the feed should fix this.  </p>

<div class="footnotes">
<hr/>
<ol>

<li id="fn1">
<p><a href="https://hosakacorp.net/p/stagit-server.html">https:&#47;&#47;hosakacorp.net&#47;p&#47;stagit-server.html</a>&#160;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

<li id="fn2">
<p>I referred to these two guides: <a href="https://medium.com/@sarala.saraswati/tor-hidden-services-on-openbsd-with-httpd-52852f49358c">https:&#47;&#47;medium.com&#47;@sarala.saraswati&#47;tor-hidden-services-on-openbsd-with-httpd-52852f49358c</a>, <a href="https://dataswamp.org/%7Esolene/2018-10-11-tor-hidden-service.html">https:&#47;&#47;dataswamp.org&#47;~solene&#47;2018-10-11-tor-hidden-service.html</a>  &#160;<a href="#fnref2" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>
</description>
</item>
<item>
<link>https://zakaria.org/posts/2021-01-11-usbkiller.html</link>
<title>Usbkill the OpenBSD Way</title>
<pubDate>Mon, 11 Jan 2021 00:00:00 +0000</pubDate>
<description>
<h1 id="%3Ccode%3Eusbkill%3C/code%3E%20the%20OpenBSD%20way"><code>usbkill</code> the OpenBSD way</h1>

<p><a href="https://github.com/hephaest0s/usbkill"><code>usbkill</code></a> is a kill-switch that shuts down your computer on any USB change. It does this by watching the output of <code>lsusb</code> and when there is a change it runs <code>shutdown -h now</code>.</p>

<p>Simple, right? One thing to note is that <code>lsusb</code> is not included in OpenBSD&#39;s base packages, but <a href="https://man.openbsd.org/hotplugd"><code>hotplugd(8)</code></a> is.</p>

<h2 id="hotplugd">hotplugd</h2>

<p>So what is <code>hotplugd</code>, and how can it be useful? The <a href="https://man.openbsd.org/hotplugd">man page</a> does a good job of explaining it. Simply put: when any device is attached to or detached from your machine <code>hotplugd</code> will execute a script.</p>

<p>To see how simple it is to write a hotplug script we can start by simply logging device attach events. First, start by enabling and starting <code>hotplugd</code> (as root):</p>

<pre><code># rcctl enable hotplugd
# rcctl start hotplugd
hotplugd(ok)
</code></pre>

<p>Next we will write the script that is executed on a device attach event:</p>

<pre><code># mkdir -p &#47;etc&#47;hotplug
# $EDITOR &#47;etc&#47;hotplug&#47;attach
</code></pre>

<p>In this file we will log the device class and name:</p>

<pre><code>#!&#47;bin&#47;sh

DEVCLASS=$1
DEVNAME=$2

# log attach event
logger -t hotplug "$DEVCLASS:$DEVNAME attached"
</code></pre>

<p>To see this in action in another terminal type</p>

<pre><code>$ tail -f &#47;var&#47;log&#47;messages
</code></pre>

<p>Then connect a USB device to your machine and you should see messages tagged &#8216;hotplug&#8217;. This is what I get when I plug in my Logitech USB adapter for my wireless mouse (which I usually don&#39;t use):</p>

<pre><code>Jan 11 11:48:32 x1 hotplug: 0:uhid3 attached
Jan 11 11:48:32 x1 hotplug: 5:wsmouse2 attached
Jan 11 11:48:32 x1 hotplug: 0:ums0 attached
Jan 11 11:48:32 x1 hotplug: 0:uhid1 attached
Jan 11 11:48:32 x1 hotplug: 5:wskbd1 attached
Jan 11 11:48:32 x1 hotplug: 0:uhid0 attached
Jan 11 11:48:32 x1 hotplug: 0:uhid4 attached
Jan 11 11:48:32 x1 hotplug: 0:uhid2 attached
Jan 11 11:48:32 x1 hotplug: 0:uhidev1 attached
Jan 11 11:48:32 x1 hotplug: 0:uhidev2 attached
Jan 11 11:48:32 x1 hotplug: 0:ukbd0 attached
Jan 11 11:48:32 x1 hotplug: 0:uhidev0 attached
Jan 11 11:48:32 x1 hotplug: 0:uhid5 attached
Jan 11 11:48:32 x1 hotplug: 0:uhid6 attached
</code></pre>

<p>Site note: What is happening here? Why have so many events popped up after inserting one USB device? My theory is that because it&#39;s a <a href="https://www.logitech.com/product/unifying-receiver-usb">Unifying Receiver</a>, it allows more than one Logitech HID to be connected to a single receiver, so it must register a bunch of HIDs to the kernel.</p>

<h2 id="The%20&amp;#8216;kill&amp;#8217;%20part">The &#8216;kill&#8217; part</h2>

<p>Now that we&#39;ve seen how <code>hotplugd</code> works, we can work on the <em>kill</em> part of <code>usbkill</code>.<br/>
We want to shutdown the machine on a device attach or detach event, but we also want to be able to arm and disarm the <em>kill</em> part, since I might need to plug something in once in a while. Make the <code>&#47;etc&#47;hotplug&#47;attach</code> script as so:</p>

<pre><code>#!&#47;bin&#47;sh

arm_file=&#47;tmp&#47;arm_usbkill

DEVCLASS="$1"
DEVNAME="$2"

logger -t "${0##*&#47;}" "${DEVCLASS}:${DEVNAME} attached"

if [ -f "$arm_file" ]; then
        shutdown -p now
else
        logger -t "${0##*&#47;}" "unarmed - aborted shutdown"
fi
</code></pre>

<p>If the <code>&#47;tmp&#47;arm_usbkill</code> file exists then the machine will shutdown, if it doesn&#39;t exist it will just add a log entry to syslog.</p>

<p><code>hotplug</code> also supports running a different script, <code>&#47;etc&#47;hotplug&#47;detach</code> on detach events. Since both scripts are exactly the same I&#39;ve symlinked the attach script to the location of the detach script.</p>

<pre><code># ln -s &#47;etc&#47;hotplug&#47;attach &#47;etc&#47;hotplug&#47;detach
</code></pre>

<p>The <code>${0##*&#47;}</code> logger tag gets substituted to the filename of the script being executed (in this case it is either <code>attach</code> or <code>detach</code>).</p>

<p>One thing to note is that this setup will execute the shutdown command on <em>any</em> device change event. This includes USBs but also includes network devices, disk drives, and serial line interfaces<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup>. If that is a problem, you can implement a device class-based whitelist by checking <code>$DEVCLASS</code>:</p>

<pre><code>#!&#47;bin&#47;sh

# class whitelist (space-separated)
class_whitelist="0 2 3 5"

# arm file
arm_file=&#47;tmp&#47;arm_usbkill

DEVCLASS="$1"
DEVNAME="$2"

whitelisted() {
    for class in $class_whitelist; do
        if [ "$class" = "$1" ]; then
            return 0
        fi
    done
    return 1
}

logger -t "${0##*&#47;}" "${DEVCLASS}:${DEVNAME} attached"

if [ -f "$arm_file" ]; then
    if whitelisted "$DEVCLASS"; then
        logger -t "${0##*&#47;}" "whitelisted - aborted shutdown"
        exit 0
    fi
    shutdown -p now
else
    logger -t "${0##*&#47;}" "unarmed - aborted shutdown"
fi
</code></pre>

<p>But this is not really useful to me since I use a laptop and I&#39;m not attaching and detaching network devices or disk drives.</p>

<p>One disadvantage of this setup is the inability to whitelist devices based on their USB IDs like you can with <code>usbkill</code>. This could be acheived through a much more complicated script using <code>usbdevs</code> to get USB IDs, but as of yet I have no need for that.</p>

<h2 id="Arming%20and%20disarming">Arming and disarming</h2>

<p>To arm and disarm this script all you have to do is create or remove the <code>$arm_file</code> respectively. Here are some shell functions to add to your shell rc to make it easier:</p>

<pre><code># arm&#47;disarm usbkill
arm() {
        touch &#47;tmp&#47;arm_usbkill &#38;&#38; printf &#39;armed\\n&#39; || printf &#39;error arming\\n&#39;
}
disarm() {
        rm -f &#47;tmp&#47;arm_usbkill &#38;&#38; printf &#39;disarmed\\n&#39; || printf &#39;error disarming\\n&#39;
}
</code></pre>

<p>The script can be armed or disarmed by any regular user which may or may not be preferable to you (and isn&#39;t the case for <code>usbkill</code>, which requires root to run).<br/>
Originally I had added the <code>uchg</code> flag to the file to lock it. But this proved to be counterproductive since it wasn&#39;t cleared from <code>&#47;tmp</code> on reboot and when <code>hotplugd</code> would first start up, it would immediately shutdown the machine again. That was fun to fix (not).</p>

<h2 id="Why?">Why?</h2>

<p>So why do all this? Why not just <code>pkg_add usbutils</code>, download + run <code>usbkill</code> and be done?<br/>
Well for starters that isn&#39;t as fun. The main reason is that all this works in a default OpenBSD install - no additional packages needed. Why install a program to solve a problem when the default tools and services can solve the problem just as (if not more) elegantly?</p>

<h2 id="SEE%20ALSO">SEE ALSO</h2>

<ul>
<li>OpenBSD <code>hotplug(4)</code> pseudo-device man page: <a href="https://man.openbsd.org/hotplug">https:&#47;&#47;man.openbsd.org&#47;hotplug</a> .</li>
<li>OpenBSD includes the <code>usbdevs(8)</code> tool in base that lists connected USB devices and their IDs: <a href="https://man.openbsd.org/usbdevs">https:&#47;&#47;man.openbsd.org&#47;usbdevs</a> <sup id="fnref2"><a href="#fn2" rel="footnote">2</a></sup>.</li>
<li>OpenWRT has it&#39;s own similarly named hotplug.d service: <a href="https://openwrt.org/docs/guide-user/base-system/hotplug">https:&#47;&#47;openwrt.org&#47;docs&#47;guide-user&#47;base-system&#47;hotplug</a>. But it&#39;s slightly different to OpenBSD&#39;s.</li>
<li>A couple of years ago I wrote <a href="https://github.com/e-zk/hidlock">a hotplug script</a> that instead runs <a href="https://man.openbsd.org/xlock"><code>xlock(1)</code></a> on all running X displays after a HID is attached. In theory this would to thwart HID&#47;badusb attacks, while not being as aggressive as shutting down your machine. Might be worth looking into if you like the sound of that.</li>
</ul>

<div class="footnotes">
<hr/>
<ol>

<li id="fn1">
<p>As per the <a href="https://man.openbsd.org/hotplugd"><code>hotplugd(8)</code> man page</a>&#160;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

<li id="fn2">
<p>In the future I might write a script to act more similarly to <code>usbkill</code>, using <code>usbdevs</code> to poll for device changes instead of <code>lsusb</code>.&#160;<a href="#fnref2" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>
</description>
</item>
<item>
<link>https://zakaria.org/posts/2021-01-04-xenodm.html</link>
<title>My xenodm setup</title>
<pubDate>Mon, 04 Jan 2021 00:00:00 +0000</pubDate>
<description>
<h1 id="My%20xenodm%20setup">My xenodm setup</h1>

<p>OpenBSD uses the <a href="https://man.openbsd.org/xenodm"><code>xenodm(1)</code></a> display manager, which is a fork of xdm.<br/>
Xenodm looks quite ugly by default, and after reading a couple<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup> of<sup id="fnref2"><a href="#fn2" rel="footnote">2</a></sup> articles<sup id="fnref3"><a href="#fn3" rel="footnote">3</a></sup> on themeing xenodm I&#39;ve come up with my own setup.</p>

<p>Before we get into the configs, here&#39;s what it actually looks like:</p>

<p><a href="/static/img/xenodm.png"><img src="/static/img/xenodm.png" alt="themed xenodm" /></a></p>

<p><em>(The text might be small, click to view the image file)</em></p>

<p>Clean and simple. Now that you&#39;ve seen what it looks like you can close this tab if that&#39;s all you came here to see. If you want to see how this is accomplished then continue reading.</p>

<h2 id="Files">Files</h2>

<p>xenodm uses multiple files for configuration. It&#39;s quite inconvenient, and I was very confused at first I admit. The files we&#39;ll have to deal with are:</p>

<pre><code>&#47;etc&#47;X11&#47;xenodm&#47;Xresources
&#47;etc&#47;X11&#47;xenodm&#47;Xsetup_0
&#47;etc&#47;X11&#47;xenodm&#47;Xsession
</code></pre>

<p>The last one is for an optional non-cosmetic change that I&#39;ll cover later. All these files require root access, so it&#39;d be wise to <code>doas -s</code> before continuing on.</p>

<h2 id="Xresources">Xresources</h2>

<p>If you&#39;ve ever dabbled in trying to rice your Unix-like operating system there&#39;s a good change you&#39;ve come across an <a href="https://wikipedia.org/wiki/X_resources">Xresources</a> file before. The X window system uses a &#8220;resource database&#8221; as a &#8216;unified&#8217; way to store configuration data.</p>

<p>xenodm sources the Xresources file before loading. Using entries in the Xresources file we can configure what the login widget (the place we type our username + password) looks like.</p>

<p>First off, I&#39;d like to be able to see my password being entered as I type with little <code>*</code> as it so commonly is.</p>

<pre><code>xlogin.Login.echoPasswd: true
</code></pre>

<p>Next I don&#39;t want to be &#8216;greeted&#8217;, and I want the message when I put my password in incorrectly to be <code>ya dun goofed</code>:</p>

<pre><code>xlogin.Login.fail: ya dun goofed
xlogin.Login.greeting:
</code></pre>

<p>Now I&#39;ll configure the dimensions and positioning of the login box:</p>

<pre><code>xlogin.Login.height:            200
xlogin.Login.width:             400
xlogin.Login.y:                 320
xlogin.Login.frameWidth:        10
xlogin.Login.innerFramesWidth:  0
</code></pre>

<p>Add some colour (or lack thereof):</p>

<pre><code>xlogin.Login.background:        #000000
xlogin.Login.foreground:        #eeeeee
xlogin.Login.failColor:         #b00035
xlogin.Login.inpColor:          #000000
xlogin.Login.promptColor:       #eeeeee
xlogin.Login.hiColor:           #000000
xlogin.Login.shdColor:          #000000
</code></pre>

<p>And finally let&#39;s use a nice bitmap font to complete the look:</p>

<pre><code>xlogin.Login.face:              Dina-11
xlogin.Login.failFace:          Dina-11
xlogin.Login.promptFace:        Dina-11
</code></pre>

<p>Note that last step requires the Dina font to be installed (it does not come with OpenBSD).</p>

<h2 id="Xsetup_0">Xsetup_0</h2>

<p>Next is the Xsetup file. Why is this called Xsetup_<em>0</em>? Because xenodm can be configured to run multiple X display servers, and the main one is 0, hence the 0 (check out <code>&#47;etc&#47;X11&#47;xenodm&#47;xenodm-config</code>).</p>

<p>This file is fairly simple. It&#39;s a shell script that xenodm runs. That&#39;s it. Simple as that. Through this script we can run pretty much any program we like. In my case, a simple lemonbar script:</p>

<pre><code>#!&#47;bin&#47;sh

# set background
&#47;usr&#47;X11R6&#47;bin&#47;xsetroot -solid \#000000

# add Dina font to font list
&#47;usr&#47;X11R6&#47;bin&#47;xset fp+ &#47;usr&#47;local&#47;share&#47;font&#47;dina
 
# status bar
(
while true; do
        reboot="%{F#b00035}%{A:reboot:} r %{A}%{F-}"
        shutdown="%{F#b00035}%{A:shutdown -p now:} p %{A}%{F-}"

        echo "  $(date &#39;+%T&#39;)  %{r}${reboot}&#47;${shutdown}  $(date &#39;+%F&#39;)    $(apm -l)%  "
        sleep 1
done | &#47;home&#47;zzz&#47;bin&#47;lemonbar -d -g 1920x40+0+0 -f &#39;Dina:style=Medium:pixelsize=13&#39; -B \#000000 -F \#eeeeee | sh
) &#38;

# uncomment to take &#39;screenshot&#39;
#(sleep 5 &#38;&#38; xwd -out &#47;tmp&#47;xenodm.xwd -root) &#38;
</code></pre>

<p>The date, time, battery percent are all piped into lemonbar. Additionally the &#8216;r&#8217; and &#8216;p&#8217; text in red allow me to reboot or power off my machine respectively.</p>

<p>It should be noted that I probably shouldn&#39;t be using a binary that&#39;s located in my user writable home directory here. Check the footnotes for other options, namely using xmessage and&#47;or xclock. Or you can just take out the lemonbar bit entirely, which I will likely do in the future.</p>

<h2 id="Xsession%20extra">Xsession extra</h2>

<p>Here&#39;s the optional bit. I&#39;m a big fan of <a href="https://github.com/vizs/declutter-home">decluttering</a> my home directory. Moving as many dotfiles out of <code>$HOME&#47;</code> as possible. Moving <code>~&#47;.Xresources</code> was easy - just source a different file from <code>~&#47;.xsession</code>. But an annoyance is <code>~&#47;.xsession</code> itself, which up until now I had no idea how to move. Turns out its location can be changed in <code>&#47;etc&#47;X11&#47;xenodm&#47;Xsession</code>!</p>

<p>Look for the line that says:</p>

<pre><code>startup=$HOME&#47;.xsession
</code></pre>

<p>Here we can change the <code>startup</code> variable to be any path we like:</p>

<pre><code>startup=${HOME}&#47;etc&#47;x&#47;xsession
</code></pre>

<p>Also, if you&#39;ve themed <a href="https://man.openbsd.org/ssh-askpass"><code>ssh-askpass(1)</code></a> like I have and want to actually see those changes when it prompts for your ssh key password then you should probably source your user Xresources before running all the ssh-related stuff.</p>

<p>Look for this part of the script:</p>

<pre><code># if we have private ssh key(s), start ssh-agent and add the key(s)
id1=$HOME&#47;.ssh&#47;identity
id2=$HOME&#47;.ssh&#47;id_dsa
id3=$HOME&#47;.ssh&#47;id_rsa
id4=$HOME&#47;.ssh&#47;id_ecdsa
id5=$HOME&#47;.ssh&#47;id_ed25519
if [ -z "$SSH_AGENT_PID" ];
then
    if [ -x &#47;usr&#47;bin&#47;ssh-agent ] &#38;&#38; [ -f $id1 -o -f $id2 -o -f $id3 -o -f $id4 -o -f $id5 ];
    then
        eval `ssh-agent -s`
        ssh-add &#60; &#47;dev&#47;null
    fi
fi
</code></pre>

<p>Just anywhere above this section simply add <code>xrdb -load $HOME&#47;path&#47;to&#47;xresources</code>.</p>

<div class="footnotes">
<hr/>
<ol>

<li id="fn1">
<p><a href="https://www.tumfatig.net/20190208/customizing-openbsd-xenodm/">https:&#47;&#47;www.tumfatig.net&#47;20190208&#47;customizing-openbsd-xenodm&#47;</a><br/>
this is the first article I read on the subject&#160;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

<li id="fn2">
<p><a href="https://www.vincentdelft.be/post/post_20190720">https:&#47;&#47;www.vincentdelft.be&#47;post&#47;post_20190720</a>&#160;<a href="#fnref2" rev="footnote">&#8617;</a></p>
</li>

<li id="fn3">
<p><a href="https://www.romanzolotarev.com/openbsd/xenodm.html">https:&#47;&#47;www.romanzolotarev.com&#47;openbsd&#47;xenodm.html</a><br/>
this article is the basis for my configuration, stylistically and config-wise.&#160;<a href="#fnref3" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>
</description>
</item>
<item>
<link>https://zakaria.org/posts/2020-12-08-openbsd-notes.html</link>
<title>OpenBSD Notes</title>
<pubDate>Tue, 08 Dec 2020 00:00:00 +0000</pubDate>
<description>
<h1 id="OpenBSD%20notes">OpenBSD notes</h1>

<p>Random notes on running <a href="https://openbsd.org/">OpenBSD</a> (some notes may only be useful for a laptop install). Updated frequently.</p>

<h2 id="Table%20of%20Contents">Table of Contents</h2>

<ul>
<li><a href="#Power%2fBattery">Power&#47;Battery</a>

<ul>
<li><a href="#Hibernate%20on%20low%20battery">Hibernate on low battery</a></li>
<li><a href="#User%20power%20commands">User power commands</a></li>
</ul></li>
<li><a href="#Multimedia">Multimedia</a>

<ul>
<li><a href="#Microphone%20Setup">Microphone Setup</a></li>
</ul></li>
<li><a href="#X">X</a></li>
<li><a href="#PF">PF</a>

<ul>
<li><a href="#Standard%20preamble">Standard preamble</a></li>
<li><a href="#Allow%20NTP">Allow NTP</a></li>
<li><a href="#VMs">VMs</a></li>
</ul></li>
<li><a href="#Misc">Misc</a></li>
<li><a href="#Manual%20pages%20as%20beautifully%20typeset%20PDFs">Manual pages as beautifully typeset PDFs</a></li>
</ul>

<h2 id="Power&amp;#47;Battery">Power&#47;Battery</h2>

<h3 id="Hibernate%20on%20low%20battery">Hibernate on low battery</h3>

<p>To hibernate at 5% remaining battery add in <code>&#47;etc&#47;rc.conf.local</code>:</p>

<pre><code class="language-bash">apmd_flags=-A -Z 5
</code></pre>

<h3 id="User%20power%20commands">User power commands</h3>

<p>In <code>&#47;etc&#47;doas.conf</code>:</p>

<pre><code>permit nopass :staff as root cmd zzz
permit nopass :staff as root cmd ZZZ
permit nopass :staff as root cmd reboot args
permit nopass :staff as root cmd shutdown args -p now
</code></pre>

<h2 id="Multimedia">Multimedia</h2>

<h3 id="Microphone%20setup">Microphone setup</h3>

<p>I have a fancy microphone that has a headphone passthrough. So it is both USB &#8220;speaker&#8221; and a USB microphone. Good news, that makes using it with sndio a <em>bit</em> easier.</p>

<p>Change primary sndiod device to the microphone (check dmesg for <code>audio[0-9]</code> device id):</p>

<pre><code># rcctl set sndiod flags -f rsnd&#47;1
# rcctl restart sndiod
</code></pre>

<p>Switch mixer sources:</p>

<pre><code># mixerctl outputs.hp_source=dac-2:3
outputs.hp_source: dac-0:1 -&#62; dac-2:3
</code></pre>

<p>To switch back, remove the sndiod flag, and change the source back to it&#39;s original value (<code>dac-0:1</code>).</p>

<h2 id="X">X</h2>

<p>See <a href="/posts/2021-01-04-xenodm.html">full post</a> for xenodm themeing.</p>

<h2 id="PF">PF</h2>

<p>Packet Filter (firewall). General stuff to remember:</p>

<ul>
<li>last rule &#8216;wins&#8217;*</li>
<li><code>egress</code> = interface(s) that hold the default route(s)</li>
</ul>

<h3 id="Standard%20preamble">Standard preamble</h3>

<pre><code># options 
set block-policy drop
set skip on lo

# default deny
block all 

# antispoofing
antispoof for egress
antispoof for $vm_int
</code></pre>

<h3 id="Allow%20NTP">Allow NTP</h3>

<p>In rare cases ntp can use tcp apparently&#8230;</p>

<pre><code>pass quick inet proto { tcp, udp } to port ntp
</code></pre>

<h3 id="VMs">VMs</h3>

<p>Don&#39;t forget to <code>sysctl net.inet.ip.forwarding=1</code>!</p>

<pre><code># where:
# vm_int        = vm interface (vether[0-9])
# vm_dns_server = dns server to be used by vms

# allow ssh traffic to vm
pass out on $vm_int proto tcp to $vm_int:network port 22

# vm nat
match out on egress from $vm_int:network to any nat-to (egress)
pass in proto { tcp udp } from $vm_int:network to any port domain \
        rdr-to $vm_dns_server port domain

# allow icmp + web from vms
pass in on $vm_int proto icmp
pass in on $vm_int proto tcp to port { www, https }

# only allow X11 forwarding on the vm interface
pass in on $vm_int proto tcp to port 6000:6010
</code></pre>

<h2 id="Misc">Misc</h2>

<h3 id="Manual%20pages%20as%20beautifully%20typeset%20PDFs">Manual pages as beautifully typeset PDFs</h3>

<pre><code class="language-console">$ MANPAGER=zathura man -T pdf style
</code></pre>
</description>
</item>
<item>
<link>https://zakaria.org/posts/2020-12-05-fonts.html</link>
<title>How I (almost) fixed my fonts</title>
<pubDate>Sat, 05 Dec 2020 00:00:00 +0000</pubDate>
<description>
<h1 id="How%20I%20(almost)%20fixed%20my%20fonts">How I (almost) fixed my fonts</h1>

<p>This site goes through CSS changes daily. Yes, daily. I can&#39;t stop changing the CSS. It&#39;s gotten to the point where I focus more on the CSS of this site than, evidently, writing posts for it. </p>

<p>I like web fonts. But I also like simplicity and straightforwardness. Sadly, getting webfonts and CSS to work together flawlessly is no simple task. </p>

<h2 id="Google%20Fonts">Google Fonts</h2>

<p>At first I just used Google Fonts: click, click, right click, copy, paste <code>@import</code> URL. Done. Fixed. &#8230;or so I thought.</p>

<p>Using Google fonts has the unfortunate side-effect that I now depend on a 3rd-party CDN for my site to look nice. That CDN is obviously Google - that&#39;s not ideal for me.</p>

<h2 id="Self-hosting%20Google%20Fonts">Self-hosting Google Fonts</h2>

<p>So I decided to just host the fonts on this webserver. I came across this gem: <a href="https://github.com/majodev/google-webfonts-helper/">google-webfonts-helper</a>. You choose your Google fonts, it generates a zip file containing the font files, and some CSS to put on your page. Perfect! &#8230;or so I thought.</p>

<h2 id="Inline%20stylesheets">Inline stylesheets</h2>

<p>Wait. Now my fonts flash for a second. Oh, this is the fabled FOUT I&#39;ve been hearing about. Google Fonts didn&#39;t seem to have this issue, though I suppose their server is far more responsive than mine, and they do some CDN tricks or something. Here&#39;s a CSS-Tricks article I read: <a href="https://css-tricks.com/how-to-load-fonts-in-a-way-that-fights-fout-and-makes-lighthouse-happy/">https:&#47;&#47;css-tricks.com&#47;how-to-load-fonts-in-a-way-that-fights-fout-and-makes-lighthouse-happy&#47;</a>. I don&#39;t recall whether it helped me in this endeavour or not since the solution requires JavaScript (eugh).</p>

<p>I decided to just inline the stylesheet to fetch the fonts and apply them since it took the browser a bit extra to download <code>styles.css</code> and since the fonts would be loaded with the webpage it shouldn&#39;t look to bad. I added <code>font-display: fallback</code> for some extra peace of mind. </p>

<pre><code class="language-css">@font-face {
    font-family: &#39;Charter Regular&#39;;
    font-style: normal;
    font-weight: normal;
    font-display: fallback;
    src: local(&#39;Charter Regular&#39;),          local(&#39;Charter-Regular&#39;),
         url(&#39;&#47;fonts&#47;charter_regular.woff&#39;) format(&#39;woff&#39;),     &#47;* Modern Browsers *&#47;
         url(&#39;&#47;fonts&#47;charter_regular.ttf&#39;)  format(&#39;truetype&#39;); &#47;* Safari, Android, iOS *&#47;
}

@font-face {
    font-family: &#39;Charter Regular&#39;;
    font-style: normal;
    font-weight: bold;
    font-display: fallback;
    src: local(&#39;Charter Bold&#39;),          local(&#39;Charter-Bold&#39;),
         url(&#39;&#47;fonts&#47;charter_bold.woff&#39;) format(&#39;woff&#39;),     &#47;* Modern Browsers *&#47;
         url(&#39;&#47;fonts&#47;charter_bold.ttf&#39;)  format(&#39;truetype&#39;); &#47;* Safari, Android, iOS *&#47;
}

html, body {
    font-family: "Charter Regular", "Times New Roman", serif;
}

</code></pre>

<p>This still didn&#39;t give the desired result. There were still weird loading times and odd font flashes.</p>

<h2 id="The%20fix%20(sort%20of&amp;#8230;%20not%20really)">The fix (sort of&#8230; not really)</h2>

<p><em>I give up</em>.</p>

<pre><code class="language-css">html, body {
    font-family: sans-serif;
}
</code></pre>

<p>Chances are whenever you&#39;re reading this the site has already been changed to reflect this change.<br/>
Sans-serif looks better for this site anyways :P  </p>
</description>
</item>
<item>
<link>https://zakaria.org/posts/2020-11-07-malthusian-belt.html</link>
<title>Malthusian Belt</title>
<pubDate>Sat, 07 Nov 2020 00:00:00 +0000</pubDate>
<description>
<h1 id="Malthusian%20Belt">Malthusian Belt</h1>

<p>I&#39;m reading Aldous Huxtley&#39;s Brave New World and as with most books I read I&#39;ve come accross many words and phrases that I don&#39;t understand. One of which was Lenina&#39;s &#8220;Malthusian belt&#8221;. At first I thought &#8220;Malthusian&#8221; refered to the belt&#39;s geographical origin (Malta? No, that would be <em>Maltese</em>), but the word didn&#39;t fit any place I knew of so naturally I looked it up.  </p>

<p>I was surprised to find this<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup> Wikipedia article on <em>Malthusianism</em>:  </p>

<blockquote>
<p>Malthusianism is the ideals has population growth is potentially exponential while the growth of the food supply or other resources is linear. </p>
</blockquote>

<p>Since everyone in the brave new world is born from artificial embryos, suppression of normal human conception is clearly important. The Malthusian belt must actually be some sort of birth control device that women generally wear.</p>

<p>It&#39;s a very interesting conceptual device and it makes me wonder about how on Earth Huxley came up with this idea. </p>

<p>While this may have been obvious to some from the name of it, or perhaps even the context in the book, it wasn&#39;t obvious to me. Not understanding the phrase prompted me to look it up. And hey, now I have a lot about Malthusiamism to read about. </p>

<div class="footnotes">
<hr/>
<ol>

<li id="fn1">
<p><a href="https://en.wikipedia.org/wiki/Malthusianism">https:&#47;&#47;en.wikipedia.org&#47;wiki&#47;Malthusianism</a>&#160;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>
</description>
</item>
<item>
<link>https://zakaria.org/posts/2020-09-09-tmux.html</link>
<title>Quick setup script with tmux</title>
<pubDate>Wed, 09 Sep 2020 00:00:00 +0000</pubDate>
<description>
<h1 id="Quick%20setup%20script%20with%20%3Ccode%3Etmux%3C/code%3E">Quick setup script with <code>tmux</code></h1>

<p>In my network security class we ssh into a handful of VMs pretty often.<br/>
Instead of trying to juggle 5 open terminal windows I tried to make this a bit easier to manage by having all my ssh sessions run in separate tmux windows - switching between them with <code>C-b {1,2,3,etc}</code> when necessary. I found myself doing this every time I&#39;d load up my Kali Linux VM:</p>

<pre><code>tmux
C-b c
ssh bastion
C-b c
ssh proxyserver
C-b c
ssh edgerouter
</code></pre>

<p>But then I thought, why not script this process? It should be easy enough. And it sure was easy. Here&#39;s what I came up with:</p>

<pre><code>#!&#47;bin&#47;sh

tmux new-session -d
tmux new-window -n "bastion" ssh bastion
tmux new-window -n "proxyserver" ssh proxyserver
tmux new-window -n "appserver" ssh appserver
tmux new-window -n "edgerouter" ssh edgerouter
tmux selectw -t 0

tmux attach-session -d
</code></pre>

<p>First, the script creates a new tmux session in the background. Then it opens a new window for each ssh session, naming them appropriately. After that it switches back to the first window (which is just a local shell), and finally it attaches the tmux session to the current terminal session.  </p>

<p>Now after I start my VM all I have to do is run the script (I called it <code>setupsess</code>), and I&#39;m ready to start hacking away at my messy nftables configs.</p>
</description>
</item>
<item>
<link>https://zakaria.org/posts/2020-08-03-m4.html</link>
<title>M4 Troubles</title>
<pubDate>Mon, 03 Aug 2020 00:00:00 +0000</pubDate>
<description>
<h1 id="M4%20Troubles&amp;#8230;">M4 Troubles&#8230;</h1>

<p>In my <a href="https://zakaria.org/posts/2020-08-01-shblog">previous post</a> I wrote about mostly M4 templates.
Well, it turns out I&#39;ve run into some issues.</p>

<h2 id="Chapter%20I:%20The%20Problem">Chapter I: The Problem</h2>

<p>I ran my blog script to convert my markdown into a nice HTML webpage, but then something happened. Nothing. Nothing happened. The script just sat there, stuck. This was odd because the script usually runs in under a second, so something had to have gone wrong&#8230;</p>

<h2 id="Chapter%20II:%20The%20Quick%20Fix">Chapter II: The Quick Fix</h2>

<p>I turned on tracing in my <code>head.m4</code> by adding <code>traceon</code> to the start of the file then I ran the script again. I knew instantly what had gone wrong&#8230; M4 was spitting out the same HTML over and over and over again: It was expanding the macros I had written in my post! Creating an infinite loop.</p>

<p>As a quick fix in the post I replaced all occurrences of my actual macros with ones that were slightly different. It worked! &#8230;but then M4 gave another error: </p>

<pre><code>m4: unexpected end of input, unclosed parenthesis:
</code></pre>

<h2 id="Chapter%20III:%20The%20Root%20of%20All%20Evil">Chapter III: The Root of All Evil</h2>

<p>In my search for answers I came across this post: <a href="http://silas.net.br/tech/devel/m4.html">http:&#47;&#47;silas.net.br&#47;tech&#47;devel&#47;m4.html</a>. While the particular issue in on the webpage wasn&#39;t <em>my</em> issue, it gave me a hint as to what had gone wrong. M4 must have been trying to expand or evaluate something else in my post&#39;s text. Eventually I figured out that M4 was trying to run all the <code>define()</code> and <code>include()</code> statements I had written in my post. Needless to say, writing a post about M4 while using M4 for my templates was causing some issues&#8230;</p>

<p>As a crappy bandaid I added a couple of <code>sed</code>s to my script:</p>

<pre><code>article_html=$(echo "$article_html" |  sed -E -e "s&#47;define\(&#47;\&#39;!define\(!\"&#47;g" -e "s&#47;include\(&#47;\&#39;!include\(!\"&#47;g")
</code></pre>

<p>Because I only wrote <code>define</code> and <code>include</code> in my M4 code snippets for the post, this worked just fine. (Hopefully it works for this post too).</p>

<p>I may have to rethink using M4 completely because I won&#39;t lie I have no idea what I&#39;m doing - it seems like I&#39;m bound to run into this issue or a similar one in the future. Maybe Timmy was wrong; maybe I should just <code>echo</code> a bunch of HTML in my script instead, surely it can&#39;t be that messy. We&#39;ll have to see what I come up with.</p>

<h2 id="Chapter%20IV:%20Going%20Forward">Chapter IV: Going Forward</h2>

<p>For now, consider my <a href="https://zakaria.org/posts/2020-08-01-shblog">previous post</a> to be non-cannon in the <code>&#47;bin&#47;sh</code> blog series (if you can really call it a series - there hasn&#39;t even been a part II yet!).</p>
</description>
</item>
<item>
<link>https://zakaria.org/posts/2020-08-01-shblog.html</link>
<title>The /bin/sh blog</title>
<pubDate>Sat, 01 Aug 2020 00:00:00 +0000</pubDate>
<description>
<h1 id="The%20&amp;#47;bin&amp;#47;sh%20Blog.%20Part%20I:%20Timmy&amp;#39;s%20Templates">The &#47;bin&#47;sh Blog. Part I: Timmy&#39;s Templates</h1>

<p>I love Unix shell scripting, in fact I may enjoy it more than &#8220;actual&#8221; programming. I say &#8220;<a href="https://wikipedia.org/wiki/Shell_script">shell scripts</a>&#8221;, as opposed to &#8220;bash scripts&#8221;, simply because I don&#39;t use bash for my scripts. The reason why is not relevant to this post. What <em>is</em> relevant is <em>why</em> make a blog using shell scripts?<br/>
Well, <em>why not</em>? After all, Makefile blogs are a <a href="https://lobste.rs/s/0skwhg/idea_makefile_blog">thing</a> that <a href="https://github.com/MaskRay/makefile-blog">exist</a>, and Makefiles are just one way of running commands to do <em>something</em>. Hmm. I wonder, what&#39;s another way of running a bunch of commands?</p>

<blockquote>
<p>Oh! I know!</p>
</blockquote>

<p>Well, what is it Timmy?</p>

<blockquote>
<p>Why, shell scripts of course!</p>
</blockquote>

<p>Woah, thanks Timmy, why that&#39;s correct.</p>

<blockquote>
<p>But how will you ever manage a website&#39;s HTML layout all in a shell script?
Wouldn&#39;t that get messy?</p>
</blockquote>

<p>Why yes Timmy, it would get pretty messy. What we need is some kind of &#8220;template&#8221; which can take some input and output HTML which we can serve&#8230;</p>

<blockquote>
<p>What about that old M4 thing?</p>
</blockquote>

<p>&#8220;M4&#8221;, Timmy? What on earth is that?</p>

<blockquote>
<p>RFTM dude: <a href="https://en.wikipedia.org/wiki/M4_(computer_language)">https:&#47;&#47;en.wikipedia.org&#47;wiki&#47;M4_(computer_language)</a>, <a href="https://man.openbsd.org/m4">https:&#47;&#47;man.openbsd.org&#47;m4</a></p>
</blockquote>

<p>Okay Timmy, no need to be rude now. We have guests, remember?</p>

<p>Ignoring Timmy&#39;s rude nature, we now have a way of making &#8220;templates&#8221; of sorts, to make building the HTML a little easier. First, we&#39;ll start with something (almost) every HTML document on the web has, a <code>&#60;head&#62;</code>:</p>

<pre><code>define(`_HTMLHEAD&#39;, `&#60;head&#62;   
&#60;title&#62;My Blog Lol&#60;&#47;title&#62;
&#60;link rel="stylsheet" href="&#47;style.css"&#47;&#62;
&#60;&#47;head&#62;&#39;)
</code></pre>

<p>Okay so now we have a <code>_HTMLHEAD</code> macro defined. In our m4 file, whenever we type <code>_HTMLHEAD</code>, the <code>&#60;head&#62;</code> containing our blog&#39;s title and a link to our stylesheet will be printed. There&#39;s only one problem, currently on every page our title is exactly the same. That is fine for some things, but for actual posts we should be able to set our <code>&#60;title&#62;</code> to be the title of our post. With M4 this is a piece of cake:</p>

<pre><code class="language-m4">define(`_HTMLHEAD&#39;, `&#60;head&#62;
&#60;title&#62;$1 - My Blog Lol&#60;&#47;title&#62;
&#60;link rel="stylsheet" href="&#47;style.css"&#47;&#62;
&#60;&#47;head&#62;&#39;)
</code></pre>

<blockquote>
<p>Well, what changed?</p>
</blockquote>

<p>See Timmy, on the second line, there is now a <code>$1 -</code> before the rest of the blog title.<br/>
In M4, macros can have arguments that can be placed into the macro&#39;s content. Now, if we call <code>_HTMLHEAD(`This is a post&#39;)</code>, the resulting HTML will be:</p>

<pre><code class="language-HTML">&#60;head&#62;
&#60;title&#62;This is a post - My Blog Lol&#60;&#47;title&#62;
&#60;link rel="stylsheet" href="&#47;style.css"&#47;&#62;
&#60;&#47;head&#62;
</code></pre>

<p>The <code>$1</code> has been replaced by our first argument, as expected. Nice. We can define more macros; for the navigation, footer, whatever you like. Here&#39;s a simple one that includes a <code>&#60;head&#62;</code> and also a <code>&#60;nav&#62;</code> block containing our site&#39;s navigation links:</p>

<pre><code class="language-m4">define(`_HTMLHEAD&#39;,`&#60;head&#62;
&#60;meta http-equiv="content-type" content="text&#47;html; charset=utf-8"&#62;
&#60;meta name="viewport" content="width=device-width, initial-scale=1"&#62;
&#60;title&#62;$1 - zakaria.org&#60;&#47;title&#62;
&#60;link rel="stylesheet" href="&#47;style.css"&#47;&#62;
&#60;&#47;head&#62;&#39;
)

define(`_HTMLNAV&#39;, `&#60;nav&#62;
&#60;p&#62;&#60;a href="&#47;"&#62;zakaria.org&#60;&#47;a&#62;&#60;br&#47;&#62;&#60;a href="&#47;posts&#47;"&#62;blog&#60;&#47;a&#62; &#47; &#60;a href="&#47;rss.xml"&#62;rss&#60;&#47;a&#62; &#47; &#60;a href="https:&#47;&#47;github.com&#47;e-zk&#47;"&#62;gh&#60;&#47;a&#62;&#60;&#47;p&#62; 
&#60;&#47;nav&#62;&#39;
)
</code></pre>

<p>For the sake of neatness, I&#39;ve placed this code in <code>head.m4</code>. 
For our individual posts, we need to write more M4. Here&#39;s a simple post template, we&#39;ll call it <code>post.m4</code>:</p>

<pre><code class="language-m4">include(m4&#47;head.m4)dnl
&#60;!DOCTYPE html&#62;
&#60;html&#62;
_HTMLHEAD(POSTTILE)
&#60;body&#62;
_HTMLNAV
&#60;main&#62;
POSTCONTENT
&#60;&#47;main&#62;
&#60;&#47;body&#62;
&#60;&#47;html&#62;
</code></pre>

<p>On the first line, we include the macros in our <code>head.m4</code>, then on line 4 we &#8220;call&#8221; our <code>_HTMLHEAD</code> macro, then shortly after we call our <code>_HTMLNAV</code> macro. M4 fills in these macros with whatever they&#39;re defined as, in our case our <code>&#60;head&#62;</code> and <code>&#60;nav&#62;</code> blocks of HTML. Neat? Right?<br/>
Moving on-</p>

<blockquote>
<p>I&#39;m confused</p>
</blockquote>

<p>About what, Timmy?</p>

<blockquote>
<p>Those strange upper-case words littered throughout the file: <code>POSTTILE</code> and <code>POSTCONTENT</code>.</p>
</blockquote>

<p>Oh! Thank you Timmy, I almost forgot. These are also macros, much the same as our <code>_HTMLNAV</code> and <code>_HTMLHEAD</code> ones, but they aren&#39;t defined in any of the M4 files we&#39;re using. That&#39;s because we define these macros when we <em>run</em> <code>m4</code> itself:</p>

<pre><code class="language-console">$ m4 -DPOSTTILE="Hello?" post.m4
</code></pre>

<p>The <code>-D</code> argument defines a symbol to have some value. In this case <code>POSTTILE</code> now becomes <code>Hello?</code> after M4 is done running. Try running:</p>

<pre><code class="language-console">$ m4 -DPOSTTILE="Test" -DPOSTCONTENT="&#60;h1&#62;Test :P&#60;&#47;h1&#62;" post.m4
</code></pre>

<p>M4 should output a &#8220;complete&#8221; HTML document, with the title &#8220;Test&#8221; and with a single heading reading &#8220;Test :P&#8221;. </p>

<p>Now that we have a (an?) M4 template set up, instead of <code>echo</code>ing a bunch of <code>&#60;html&#62;</code> in our script, now all we have to do is call <code>m4</code> and pass arguments to it for our content to show up in the resulting HTML.</p>

<p>Don&#39;t be mad. But that&#39;s the end of this post. <em>I know, I know</em> we didn&#39;t actually write any shell script just yet, (Timmy is giving me the stink eye right now), but that&#39;s for another time.<br/>
Stay tuned for part II.</p>
</description>
</item>
</channel>
</rss>
